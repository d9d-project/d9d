<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        // for search plugin notably
        const base_url = "https://d9d-project.github.io/d9d/";
    </script>
    <script>
    const darkTheme = window.matchMedia("(prefers-color-scheme: dark)");
    darkTheme.onchange = (e) => {
        if (e.matches) {
            document.documentElement.classList.add("dark")
            localStorage.theme = 'dark';
        } else {
            document.documentElement.classList.remove("dark")
            localStorage.removeItem("theme")
        }
    };

    // On page load. Priotiry to lcaolStorage
    if (localStorage.theme === "dark") {
        document.documentElement.classList.add("dark")
    } else if (localStorage.theme === "light") {
        document.documentElement.classList.remove("dark")
    } else if (darkTheme.matches) {
        document.documentElement.classList.add("dark")
    } else {
        document.documentElement.classList.remove("dark")
    }

    // set the layout based on localStorage
    document.documentElement.classList.add(localStorage.getItem("html-layout") || "layout-fixed");
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Qwen3 MoE - d9d</title>
    


<title>Qwen3 MoE</title>









<link rel="canonical" href="https://d9d-project.github.io/d9d/models/qwen3_moe/">


<!-- Open Graph (Facebook, LinkedIn) -->

<meta property="og:title" content="Qwen3 MoE">





<meta property="og:url" content="https://d9d-project.github.io/d9d/models/qwen3_moe/">






<!-- Twitter Card -->

<meta name="twitter:title" content="Qwen3 MoE">






<!-- JSON-LD Structured Data -->



    <link rel="icon" href="../../img/favicon.ico">

    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/geist.css" rel="stylesheet">

    
    

<link id="pygments-light" rel="stylesheet"
    href="../../css/pygments/a11y-light.css">
<link id="pygments-dark" rel="stylesheet"
    href="../../css/pygments/a11y-dark.css"
    media="(prefers-color-scheme: dark)">


    
    <link href="../../assets/_mkdocstrings.css" rel="stylesheet">
    <link href="../../style/style.css" rel="stylesheet">

    

    <script src="../../js/callbacks.js"></script>

    
    <!-- katex -->
<link rel="stylesheet" href="../../css/katex.min.css">
<!-- The loading of KaTeX is deferred to speed up page rendering -->
<script defer src="../../js/katex.min.js"></script>
<!-- To automatically render math in text elements, include the auto-render extension: -->
<script defer src="../../js/auto-render.min.js"
    onload='renderMathInElement(document.body, "{}");'></script>
    

    

    

</head>

<body
    class="text-foreground group/body overscroll-none font-sans antialiased [--footer-height:calc(var(--spacing)*14)] [--header-height:calc(var(--spacing)*14)] xl:[--footer-height:calc(var(--spacing)*24)] theme-default">
    <div id="inner-body" class="bg-background relative z-10 flex min-h-svh flex-col">
        <header class="bg-background sticky top-0 z-50 w-full" view-transition-name="header">
    <div class="container-wrapper 3xl:fixed:px-0 px-6">
        <div class="3xl:fixed:container flex h-(--header-height) items-center gap-2 **:data-[slot=separator]:!h-4">
            <button id="menu-button" data-slot="popover-trigger" onclick="onMobileMenuButtonClick(event)"
                class="group whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*='size-'])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:text-accent-foreground px-4 py-2 has-[&gt;svg]:px-3 extend-touch-target h-8 touch-manipulation items-center justify-start gap-2.5 !p-0 hover:bg-transparent focus-visible:bg-transparent focus-visible:ring-0 active:bg-transparent dark:hover:bg-transparent flex lg:hidden"
                type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-«Rmplb»"
                data-state="closed">
                <div class="relative flex h-8 w-4 items-center justify-center">
                    <div class="relative size-4">
                        <!-- 16px x 16px -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="0" x2="16" y1="5" y2="5"
                                class="group-data-[state=open]:translate-y-[2.25px] group-data-[state=open]:-translate-x-[2.25px] group-data-[state=open]:rotate-45 transition-all duration-300 origin-center" />
                            <line x1="0" x2="16" y1="11" y2="11"
                                class="group-data-[state=open]:-translate-y-[2.25px] group-data-[state=open]:-translate-x-[2.25px] group-data-[state=open]:-rotate-45 transition-all duration-300 origin-center" />
                        </svg>
                    </div>

                    <span class="sr-only">Toggle Menu</span>
                </div>
                <span class="flex h-8 items-center text-lg leading-none font-medium">Menu</span>
            </button>
            <a data-slot="button"
                class="items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-5 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 hidden h-8 lg:flex"
                href="https://d9d-project.github.io/d9d/">
                <span class="size-8 flex flex-row justify-center items-center">
                    

<img class="size-5" src="https://avatars.githubusercontent.com/u/248787421" alt="icon">


                </span>

                
                <h1 class="pr-2">d9d</h1>
                
            </a>
            
            <div class="ml-auto flex items-center gap-2 md:flex-1 md:justify-end">
                <div class="hidden w-full flex-1 md:flex md:w-auto md:flex-none">
                    <button data-slot="dialog-trigger" onclick="onSearchBarClick(event)"
    class="inline-flex items-center gap-2 whitespace-nowrap rounded-md text-sm transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*='size-'])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-secondary/80 px-4 py-2 has-[&gt;svg]:px-3 bg-surface text-surface-foreground/60 dark:bg-card relative h-8 w-full justify-start pl-2.5 font-normal shadow-none sm:pr-12 md:w-40 lg:w-56 xl:w-64"
    type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-«R66plb»" data-state="closed">
    <span class="text-muted-foreground hidden lg:inline-flex">Search documentation...</span>
    <span class="text-muted-foreground inline-flex lg:hidden">Search...</span>
    <div class="absolute top-1.5 right-1.5 hidden gap-1 sm:flex">
        <kbd
            class="bg-background text-muted-foreground pointer-events-none flex h-5 items-center justify-center gap-1 rounded border px-1 font-sans text-[0.7rem] font-medium select-none [&amp;_svg:not([class*='size-'])]:size-3">Ctrl</kbd><kbd
            class="bg-background text-muted-foreground pointer-events-none flex h-5 items-center justify-center gap-1 rounded border px-1 font-sans text-[0.7rem] font-medium select-none [&amp;_svg:not([class*='size-'])]:size-3 aspect-square">K</kbd>
    </div>
</button>
<dialog id="search-dialog" onclick="onSearchDialogClick(event)"
    class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-background rounded-lg shadow-lg border overflow-hidden p-0">
    <div class="w-lg gap-4">
        <div class="flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground">
            <div data-slot="command-input-wrapper" class="flex h-9 items-center gap-2 border-b px-3"><svg
                    xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-search size-4 shrink-0 opacity-50">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                <input data-slot="command-input"
                    class="placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-hidden disabled:cursor-not-allowed disabled:opacity-50"
                    placeholder="Search documentation..." cmdk-input="" autocomplete="off" autocorrect="off"
                    spellcheck="false" aria-autocomplete="list" role="combobox" aria-expanded="true"
                    aria-controls="radix-«r1t6»" aria-labelledby="radix-«r1t7»" id="radix-«r1t8»" type="text" value=""
                    aria-activedescendant="radix-«r1th»" oninput="onInputHandler(event)">
            </div>
        </div>
        <div id="mkdocs-search-results">
            <!-- search results go there -->
        </div>
    </div>
</dialog>
<script>
    document.removeEventListener("keydown", searchShortcutHandler);
    document.addEventListener("keydown", searchShortcutHandler);
</script>
                </div>
                <div data-orientation="vertical" role="none" data-slot="separator"
                    class="bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px ml-2 hidden lg:block">
                </div>
                <a target="_blank" rel="noreferrer" data-slot="button"
                    class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*='size-'])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 rounded-md gap-1.5 px-3 has-[&gt;svg]:px-2.5 h-8 shadow-none"
                    href="https://github.com/d9d-project/d9d">
                    <svg viewBox="0 0 438.549 438.549">
                        <path fill="currentColor"
                            d="M409.132 114.573c-19.608-33.596-46.205-60.194-79.798-79.8-33.598-19.607-70.277-29.408-110.063-29.408-39.781 0-76.472 9.804-110.063 29.408-33.596 19.605-60.192 46.204-79.8 79.8C9.803 148.168 0 184.854 0 224.63c0 47.78 13.94 90.745 41.827 128.906 27.884 38.164 63.906 64.572 108.063 79.227 5.14.954 8.945.283 11.419-1.996 2.475-2.282 3.711-5.14 3.711-8.562 0-.571-.049-5.708-.144-15.417a2549.81 2549.81 0 01-.144-25.406l-6.567 1.136c-4.187.767-9.469 1.092-15.846 1-6.374-.089-12.991-.757-19.842-1.999-6.854-1.231-13.229-4.086-19.13-8.559-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-.951-2.568-2.098-3.711-3.429-1.142-1.331-1.997-2.663-2.568-3.997-.572-1.335-.098-2.43 1.427-3.289 1.525-.859 4.281-1.276 8.28-1.276l5.708.853c3.807.763 8.516 3.042 14.133 6.851 5.614 3.806 10.229 8.754 13.846 14.842 4.38 7.806 9.657 13.754 15.846 17.847 6.184 4.093 12.419 6.136 18.699 6.136 6.28 0 11.704-.476 16.274-1.423 4.565-.952 8.848-2.383 12.847-4.285 1.713-12.758 6.377-22.559 13.988-29.41-10.848-1.14-20.601-2.857-29.264-5.14-8.658-2.286-17.605-5.996-26.835-11.14-9.235-5.137-16.896-11.516-22.985-19.126-6.09-7.614-11.088-17.61-14.987-29.979-3.901-12.374-5.852-26.648-5.852-42.826 0-23.035 7.52-42.637 22.557-58.817-7.044-17.318-6.379-36.732 1.997-58.24 5.52-1.715 13.706-.428 24.554 3.853 10.85 4.283 18.794 7.952 23.84 10.994 5.046 3.041 9.089 5.618 12.135 7.708 17.705-4.947 35.976-7.421 54.818-7.421s37.117 2.474 54.823 7.421l10.849-6.849c7.419-4.57 16.18-8.758 26.262-12.565 10.088-3.805 17.802-4.853 23.134-3.138 8.562 21.509 9.325 40.922 2.279 58.24 15.036 16.18 22.559 35.787 22.559 58.817 0 16.178-1.958 30.497-5.853 42.966-3.9 12.471-8.941 22.457-15.125 29.979-6.191 7.521-13.901 13.85-23.131 18.986-9.232 5.14-18.182 8.85-26.84 11.136-8.662 2.286-18.415 4.004-29.263 5.146 9.894 8.562 14.842 22.077 14.842 40.539v60.237c0 3.422 1.19 6.279 3.572 8.562 2.379 2.279 6.136 2.95 11.276 1.995 44.163-14.653 80.185-41.062 108.068-79.226 27.88-38.161 41.825-81.126 41.825-128.906-.01-39.771-9.818-76.454-29.414-110.049z">
                        </path>
                    </svg>
                    
                    <span id="stargazers" class="text-muted-foreground w-8 text-xs tabular-nums" onload="test()">
                    </span>
                    
                </a>
                <div data-orientation="vertical" role="none" data-slot="separator"
                    class="bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px 3xl:flex hidden">
                </div>
                <button data-slot="button"
                    class="items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*='size-'])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 size-8 3xl:flex hidden"
                    title="Toggle layout" onclick="toggleLayout(event)">
                    <span class="sr-only">Toggle layout</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-gallery-horizontal">
                        <path d="M2 3v18"></path>
                        <rect width="12" height="18" x="6" y="3" rx="2"></rect>
                        <path d="M22 3v18"></path>
                    </svg>
                </button>
                <div data-orientation="vertical" role="none" data-slot="separator"
                    class="bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px">
                </div>
                <button data-slot="button"
                    class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*='size-'])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 group/toggle extend-touch-target size-8"
                    title="Toggle theme" onclick="onThemeSwitch(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="size-4.5">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                        <path d="M12 3l0 18"></path>
                        <path d="M12 9l4.65 -4.65"></path>
                        <path d="M12 14.3l7.37 -7.37"></path>
                        <path d="M12 19.6l8.85 -8.85"></path>
                    </svg>
                    <span class="sr-only">Toggle theme</span>
                </button>
            </div>
        </div>
    </div>
</header>
        <main class="flex flex-1 flex-col">
            <div class="container-wrapper flex flex-1 flex-col px-2">
                <div data-slot="sidebar-wrapper" style="--sidebar-width: 16rem; --sidebar-width-icon: 3rem;"
                    class="group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex w-full 3xl:fixed:container 3xl:fixed:px-3 min-h-min flex-1 items-start px-0 [--sidebar-width:220px] [--top-spacing:0] lg:grid lg:grid-cols-[var(--sidebar-width)_minmax(0,1fr)] lg:[--sidebar-width:240px] lg:[--top-spacing:calc(var(--spacing)*4)]">
                    <div data-slot="sidebar"
                        class="text-sidebar-foreground w-(--sidebar-width) flex-col sticky top-[calc(var(--header-height)+1px)] z-30 hidden h-[calc(100svh-var(--header-height)-var(--footer-height))] bg-transparent lg:flex">
                        <div data-slot="sidebar-content" data-sidebar="content"
                            class="flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden no-scrollbar px-2 pb-12">
                            <div class="h-(--top-spacing) shrink-0"></div>
                            <div view-transition-name="sidebar" data-slot="sidebar-group" data-sidebar="group"
    class="relative flex w-full min-w-0 flex-col p-2 no-scrollbar">
    

    
    
    

    

    
    

    
    <div data-slot="sidebar-group" data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2">
        <div data-slot="sidebar-group-content" data-sidebar="group-content" class="w-full text-sm">
            <ul data-slot="sidebar-menu" data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-0.5">
                
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Home
        

        

        

        
    </a>
</li>
                
                
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/toc/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Table of Contents
        

        

        

        
    </a>
</li>
                
                
            </ul>
        </div>
    </div>
    

    
    
    <div data-slot="sidebar-group" data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2">
        <div data-slot="sidebar-group-label" data-sidebar="group-label"
            class="ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0 text-muted-foreground font-medium">
            Loop</div>
        <div data-slot="sidebar-group-content" data-sidebar="group-content" class="w-full text-sm">
            <ul data-slot="sidebar-menu" data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-0.5">
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/0_loop/0_index/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Training Loop
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/0_loop/1_inference_loop/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Inference Loop
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/0_loop/config/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Configuration
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/0_loop/interfaces/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Interfaces & Logic
        

        

        

        
    </a>
</li>
                
            </ul>
        </div>
    </div>
    
    
    
    <div data-slot="sidebar-group" data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2">
        <div data-slot="sidebar-group-label" data-sidebar="group-label"
            class="ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0 text-muted-foreground font-medium">
            Core</div>
        <div data-slot="sidebar-group-content" data-sidebar="group-content" class="w-full text-sm">
            <ul data-slot="sidebar-menu" data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-0.5">
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/core/autograd_extensions/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Autograd Extensions
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/core/dist_context/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Distributed Context
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/core/dist_ops/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Distributed Operations
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/core/sharding/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        PyTree Sharding
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/core/types/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Typing Extensions
        

        

        

        
    </a>
</li>
                
            </ul>
        </div>
    </div>
    
    
    
    <div data-slot="sidebar-group" data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2">
        <div data-slot="sidebar-group-label" data-sidebar="group-label"
            class="ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0 text-muted-foreground font-medium">
            Dataset</div>
        <div data-slot="sidebar-group-content" data-sidebar="group-content" class="w-full text-sm">
            <ul data-slot="sidebar-menu" data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-0.5">
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/dataset/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Datasets
        

        

        

        
    </a>
</li>
                
            </ul>
        </div>
    </div>
    
    
    
    <div data-slot="sidebar-group" data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2">
        <div data-slot="sidebar-group-label" data-sidebar="group-label"
            class="ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0 text-muted-foreground font-medium">
            Internals</div>
        <div data-slot="sidebar-group-content" data-sidebar="group-content" class="w-full text-sm">
            <ul data-slot="sidebar-menu" data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-0.5">
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/internals/determinism/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Determinism
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/internals/grad_norm/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Gradient Norm & Clipping
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/internals/grad_sync/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Gradient Synchronization
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/internals/metric_collector/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Metric Collection
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/internals/pipeline_state/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Pipeline State Management
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/internals/pipelining/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Pipelining Internals
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/internals/profiling/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Distributed Profiling
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/internals/tracker_integration/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Experiment Tracking
        

        

        

        
    </a>
</li>
                
            </ul>
        </div>
    </div>
    
    
    
    <div data-slot="sidebar-group" data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2">
        <div data-slot="sidebar-group-label" data-sidebar="group-label"
            class="ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0 text-muted-foreground font-medium">
            Lr scheduler</div>
        <div data-slot="sidebar-group-content" data-sidebar="group-content" class="w-full text-sm">
            <ul data-slot="sidebar-menu" data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-0.5">
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/lr_scheduler/piecewise/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Piecewise Scheduler
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/lr_scheduler/visualization/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Visualization
        

        

        

        
    </a>
</li>
                
            </ul>
        </div>
    </div>
    
    
    
    <div data-slot="sidebar-group" data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2">
        <div data-slot="sidebar-group-label" data-sidebar="group-label"
            class="ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0 text-muted-foreground font-medium">
            Metric</div>
        <div data-slot="sidebar-group-content" data-sidebar="group-content" class="w-full text-sm">
            <ul data-slot="sidebar-menu" data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-0.5">
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/metric/0_index/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Metrics
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/metric/custom/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Custom Metrics
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/metric/implemented/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Implemented Metrics
        

        

        

        
    </a>
</li>
                
            </ul>
        </div>
    </div>
    
    
    
    <div data-slot="sidebar-group" data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2">
        <div data-slot="sidebar-group-label" data-sidebar="group-label"
            class="ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0 text-muted-foreground font-medium">
            Model states</div>
        <div data-slot="sidebar-group-content" data-sidebar="group-content" class="w-full text-sm">
            <ul data-slot="sidebar-menu" data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-0.5">
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/model_states/io/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Model State I/O
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/model_states/mapper/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Model State Mapper
        

        

        

        
    </a>
</li>
                
            </ul>
        </div>
    </div>
    
    
    
    <div data-slot="sidebar-group" data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2">
        <div data-slot="sidebar-group-label" data-sidebar="group-label"
            class="ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0 text-muted-foreground font-medium">
            Models</div>
        <div data-slot="sidebar-group-content" data-sidebar="group-content" class="w-full text-sm">
            <ul data-slot="sidebar-menu" data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-0.5">
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/models/1_model_design/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Model Design
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/models/2_horizontal_parallelism/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Horizontal Parallelism
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/models/3_pipeline_parallelism/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Pipeline Parallelism
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/models/4_model_catalogue/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Model Catalogue
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="true" data-sidebar="menu-button"
        data-size="default" href="/d9d/models/qwen3_moe/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Qwen3 MoE
        

        

        

        
    </a>
</li>
                
            </ul>
        </div>
    </div>
    
    
    
    <div data-slot="sidebar-group" data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2">
        <div data-slot="sidebar-group-label" data-sidebar="group-label"
            class="ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0 text-muted-foreground font-medium">
            Modules</div>
        <div data-slot="sidebar-group-content" data-sidebar="group-content" class="w-full text-sm">
            <ul data-slot="sidebar-menu" data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-0.5">
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/modules/attention/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Attention Layers
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/modules/embedding/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Embeddings
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/modules/ffn/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Feed Forward Networks (FFN)
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/modules/head/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Model Heads
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/modules/hidden_states_aggregator/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Hidden States Aggregation
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/modules/moe/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Mixture of Experts (MoE)
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/modules/positional/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Positional Embeddings
        

        

        

        
    </a>
</li>
                
            </ul>
        </div>
    </div>
    
    
    
    <div data-slot="sidebar-group" data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2">
        <div data-slot="sidebar-group-label" data-sidebar="group-label"
            class="ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0 text-muted-foreground font-medium">
            Optimizer</div>
        <div data-slot="sidebar-group-content" data-sidebar="group-content" class="w-full text-sm">
            <ul data-slot="sidebar-menu" data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-0.5">
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/optimizer/stochastic/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Stochastic Optimizers
        

        

        

        
    </a>
</li>
                
            </ul>
        </div>
    </div>
    
    
    
    <div data-slot="sidebar-group" data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2">
        <div data-slot="sidebar-group-label" data-sidebar="group-label"
            class="ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0 text-muted-foreground font-medium">
            Peft</div>
        <div data-slot="sidebar-group-content" data-sidebar="group-content" class="w-full text-sm">
            <ul data-slot="sidebar-menu" data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-0.5">
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/peft/0_index/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        PEFT Overview
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/peft/full_tune/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Full Fine-Tuning
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/peft/lora/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        LoRA
        

        

        

        
    </a>
</li>
                
                <li data-slot="sidebar-menu-item" data-sidebar="menu-item" class="group/menu-item relative">
    <a data-slot="sidebar-menu-button" data-active="false" data-sidebar="menu-button"
        data-size="default" href="/d9d/peft/stack/"
        class="hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer/menu-button flex items-center gap-2 rounded-md p-2 text-left outline-hidden ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 data-[active=true]:bg-accent data-[active=true]:border-accent 3xl:fixed:w-full 3xl:fixed:max-w-48 relative h-[30px] w-fit overflow-visible border border-transparent text-[0.8rem] font-medium after:absolute after:inset-x-0 after:-inset-y-1 after:z-0 after:rounded-md">

        
        Method Stacking
        

        

        

        
    </a>
</li>
                
            </ul>
        </div>
    </div>
    
    


    
</div>
                        </div>
                    </div>
                    <div class="h-full w-full">
                        <div data-slot="docs" class="flex items-stretch text-[1.05rem] sm:text-[15px] xl:w-full">
                            <div class="flex min-w-0 flex-1 flex-col">
                                <div class="h-(--top-spacing) shrink-0"></div>
                                <article class="w-full" view-transition-name="page">
  <div class="flex flex-col gap-2">
    <div class="flex flex-col gap-2">
      <div id="page-header" class="flex items-start justify-between">
        <h1
          class="scroll-m-20 text-4xl font-semibold tracking-tight sm:text-3xl xl:text-4xl"
        >
          Qwen3 MoE
        </h1>

        <div class="flex items-center gap-2 pt-1.5">
          
<button onclick="fetch(`https://d9d-project.github.io/d9d/models/qwen3_moe.md`).then((r) => r.blob()).then((blob) => navigator.clipboard.write([new ClipboardItem({ 'text/plain': blob })]))" 
        data-slot="button" 
        class="cursor-pointer inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive bg-secondary text-secondary-foreground hover:bg-secondary/80 rounded-md gap-1.5 px-3 has-[&>svg]:px-2.5 h-8 shadow-none md:h-7 md:text-[0.8rem]">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-copy ">
    <path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z"></path><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1"></path>
</svg>
<span class="max-md:hidden">Copy Page</span>
</button> 
          
          <a
            data-slot="button"
            id="previous-button"
            class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*='size-'])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive bg-secondary text-secondary-foreground hover:bg-secondary/80 extend-touch-target size-8 shadow-none md:size-7"
            href="/d9d/models/4_model_catalogue/"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="tabler-icon tabler-icon-arrow-left"
            >
              <path d="M5 12l14 0"></path>
              <path d="M5 12l6 6"></path>
              <path d="M5 12l6 -6"></path>
            </svg>
            <span class="sr-only">Previous</span>
          </a>
           
          
          <a
            data-slot="button"
            id="next-button"
            class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*='size-'])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive bg-secondary text-secondary-foreground hover:bg-secondary/80 extend-touch-target size-8 shadow-none md:size-7"
            href="/d9d/modules/attention/"
          >
            <span class="sr-only">Next</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="tabler-icon tabler-icon-arrow-right"
            >
              <path d="M5 12l14 0"></path>
              <path d="M13 18l6 -6"></path>
              <path d="M13 6l6 6"></path>
            </svg>
          </a>
          
        </div>
      </div>
      
    </div>
    <div class="flex justify-end items-center">
        <div class="grow text-muted-foreground pt-4 flex flex-row justify-end items-center">
    <span id="updated_at" class="text-sm opacity-50 hover:opacity-100 transition-opacity duration-200"
        title="last update (local time)"></span>
</div>

<script>
    const updatedAt = document.getElementById("updated_at");
    if (updatedAt) {
        const date = new Date('2026-02-13T00:36:14+03:00');
        updatedAt.textContent = date.toLocaleDateString();
    }
</script>
 
    </div>
  </div>
  <div class="typography w-full flex-1 *:data-[slot=alert]:first:mt-0">
    <h2 id="about">About</h2>
<p>The <code>d9d.module.model.qwen3_moe</code> package implements the Qwen3 Mixture-of-Experts model architecture.</p>
<p>The <code>d9d.module.parallelism.model.qwen3_moe</code> package implements default horizontal parallelism strategy for this model.</p>


<div class="doc doc-object doc-module">



<h2 id="d9d.module.model.qwen3_moe" class="doc doc-heading">
            <code>d9d.module.model.qwen3_moe</code>


</h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="d9d.module.model.qwen3_moe.Qwen3MoEForCausalLM" class="doc doc-heading">
            <code>Qwen3MoEForCausalLM</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code>, <code><a class="autorefs autorefs-internal" title="ModuleLateInit (d9d.module.base.ModuleLateInit)" href="../1_model_design/#d9d.module.base.ModuleLateInit">ModuleLateInit</a></code>, <code><a class="autorefs autorefs-internal" title="ModuleSupportsPipelining (d9d.pipelining.api.ModuleSupportsPipelining)" href="../3_pipeline_parallelism/#d9d.pipelining.api.ModuleSupportsPipelining">ModuleSupportsPipelining</a></code></p>



        <p>A Qwen3 MoE model wrapped with a Causal Language Modeling head.</p>
<p>It is designed to be split across multiple pipeline stages.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
                <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Qwen3MoEForCausalLM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">ModuleLateInit</span><span class="p">,</span> <span class="n">ModuleSupportsPipelining</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Qwen3 MoE model wrapped with a Causal Language Modeling head.</span>

<span class="sd">    It is designed to be split across multiple pipeline stages.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Qwen3MoEForCausalLMParameters</span><span class="p">,</span>
        <span class="n">stage</span><span class="p">:</span> <span class="n">PipelineStageInfo</span><span class="p">,</span>
        <span class="n">hidden_states_snapshot_mode</span><span class="p">:</span> <span class="n">HiddenStatesAggregationMode</span><span class="p">,</span>
        <span class="n">enable_checkpointing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the Qwen3MoEForCausalLM object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params: Full model configuration parameters.</span>
<span class="sd">            stage: Pipeline stage information for this instance.</span>
<span class="sd">            hidden_states_snapshot_mode: Configures intermediate hidden state aggregation &amp; snapshotting mode.</span>
<span class="sd">            enable_checkpointing: Whether to enable activation checkpointing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Qwen3MoEModel</span><span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">stage</span><span class="p">,</span>
            <span class="n">hidden_states_snapshot_mode</span><span class="o">=</span><span class="n">hidden_states_snapshot_mode</span><span class="p">,</span>
            <span class="n">enable_checkpointing</span><span class="o">=</span><span class="n">enable_checkpointing</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span> <span class="o">=</span> <span class="n">SplitLanguageModellingHead</span><span class="p">(</span>
                <span class="n">split_vocab_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">split_vocab_size</span><span class="p">,</span>
                <span class="n">split_order</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">split_vocab_order</span><span class="p">,</span>
                <span class="n">hidden_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span> <span class="o">=</span> <span class="n">stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_size</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hidden_states</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">position_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hidden_states_snapshot</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hidden_states_agg_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the model forward pass.</span>

<span class="sd">        If this is the last stage, it expects `labels` to be provided and computes</span>
<span class="sd">        the cross-entropy loss (returned as &#39;logps&#39; typically representing per-token loss).</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids: Input token IDS (for Stage 0).</span>
<span class="sd">            hidden_states: Hidden states from previous stage (for Stage &gt; 0).</span>
<span class="sd">            position_ids: Positional indices for RoPE.</span>
<span class="sd">            hidden_states_snapshot: Intermediate state collector.</span>
<span class="sd">            hidden_states_agg_mask: Mask for state aggregation.</span>
<span class="sd">            labels: Target tokens for loss computation (Last Stage).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing &#39;hidden_states&#39;, optionally &#39;hidden_states_snapshot&#39;,</span>
<span class="sd">            and per-token &#39;logps&#39; if on the last stage.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">model_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
            <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
            <span class="n">hidden_states</span><span class="o">=</span><span class="n">hidden_states</span><span class="p">,</span>
            <span class="n">position_ids</span><span class="o">=</span><span class="n">position_ids</span><span class="p">,</span>
            <span class="n">hidden_states_snapshot</span><span class="o">=</span><span class="n">hidden_states_snapshot</span><span class="p">,</span>
            <span class="n">hidden_states_agg_mask</span><span class="o">=</span><span class="n">hidden_states_agg_mask</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
            <span class="n">lm_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span><span class="p">(</span><span class="n">hidden_states</span><span class="o">=</span><span class="n">model_outputs</span><span class="p">[</span><span class="s2">&quot;hidden_states&quot;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">model_outputs</span><span class="p">[</span><span class="s2">&quot;logps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm_out</span>
        <span class="k">return</span> <span class="n">model_outputs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets module parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_moe_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets MoE routing statistics in the backbone.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reset_moe_stats</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">moe_tokens_per_expert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Accesses MoE routing statistics from the backbone.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">moe_tokens_per_expert</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">infer_stage_inputs_from_pipeline_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">n_microbatches</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">infer_stage_inputs_from_pipeline_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">n_microbatches</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">infer_stage_outputs_from_pipeline_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">n_microbatches</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">pp_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">infer_stage_outputs_from_pipeline_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">n_microbatches</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
            <span class="n">pp_outputs</span><span class="p">[</span><span class="s2">&quot;logps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pp_outputs</span>
</code></pre></div></td></tr></table></div></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEForCausalLM.moe_tokens_per_expert" class="doc doc-heading">
            <code class=" language-python"><span class="n">moe_tokens_per_expert</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Accesses MoE routing statistics from the backbone.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEForCausalLM.__init__" class="doc doc-heading">
            <code class=" language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">hidden_states_snapshot_mode</span><span class="p">,</span> <span class="n">enable_checkpointing</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Constructs the Qwen3MoEForCausalLM object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>params</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Qwen3MoEForCausalLMParameters (d9d.module.model.qwen3_moe.params.Qwen3MoEForCausalLMParameters)" href="#d9d.module.model.qwen3_moe.Qwen3MoEForCausalLMParameters">Qwen3MoEForCausalLMParameters</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Full model configuration parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stage</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PipelineStageInfo


  
      dataclass
   (d9d.pipelining.api.PipelineStageInfo)" href="../3_pipeline_parallelism/#d9d.pipelining.api.PipelineStageInfo">PipelineStageInfo</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pipeline stage information for this instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states_snapshot_mode</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="HiddenStatesAggregationMode (d9d.module.block.hidden_states_aggregator.HiddenStatesAggregationMode)" href="../../modules/hidden_states_aggregator/#d9d.module.block.hidden_states_aggregator.HiddenStatesAggregationMode">HiddenStatesAggregationMode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configures intermediate hidden state aggregation &amp; snapshotting mode.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_checkpointing</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable activation checkpointing.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Qwen3MoEForCausalLMParameters</span><span class="p">,</span>
    <span class="n">stage</span><span class="p">:</span> <span class="n">PipelineStageInfo</span><span class="p">,</span>
    <span class="n">hidden_states_snapshot_mode</span><span class="p">:</span> <span class="n">HiddenStatesAggregationMode</span><span class="p">,</span>
    <span class="n">enable_checkpointing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs the Qwen3MoEForCausalLM object.</span>

<span class="sd">    Args:</span>
<span class="sd">        params: Full model configuration parameters.</span>
<span class="sd">        stage: Pipeline stage information for this instance.</span>
<span class="sd">        hidden_states_snapshot_mode: Configures intermediate hidden state aggregation &amp; snapshotting mode.</span>
<span class="sd">        enable_checkpointing: Whether to enable activation checkpointing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Qwen3MoEModel</span><span class="p">(</span>
        <span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
        <span class="n">stage</span><span class="p">,</span>
        <span class="n">hidden_states_snapshot_mode</span><span class="o">=</span><span class="n">hidden_states_snapshot_mode</span><span class="p">,</span>
        <span class="n">enable_checkpointing</span><span class="o">=</span><span class="n">enable_checkpointing</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span> <span class="o">=</span> <span class="n">SplitLanguageModellingHead</span><span class="p">(</span>
            <span class="n">split_vocab_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">split_vocab_size</span><span class="p">,</span>
            <span class="n">split_order</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">split_vocab_order</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span> <span class="o">=</span> <span class="n">stage</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_size</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEForCausalLM.forward" class="doc doc-heading">
            <code class=" language-python"><span class="n">forward</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden_states</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden_states_snapshot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden_states_agg_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Executes the model forward pass.</p>
<p>If this is the last stage, it expects <code>labels</code> to be provided and computes
the cross-entropy loss (returned as 'logps' typically representing per-token loss).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_ids</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input token IDS (for Stage 0).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hidden states from previous stage (for Stage &gt; 0).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>position_ids</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positional indices for RoPE.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states_snapshot</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Intermediate state collector.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states_agg_mask</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mask for state aggregation.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>labels</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target tokens for loss computation (Last Stage).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table></div>


    <p><span class="doc-section-title">Returns:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing 'hidden_states', optionally 'hidden_states_snapshot',</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and per-token 'logps' if on the last stage.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hidden_states</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">position_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hidden_states_snapshot</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hidden_states_agg_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the model forward pass.</span>

<span class="sd">    If this is the last stage, it expects `labels` to be provided and computes</span>
<span class="sd">    the cross-entropy loss (returned as &#39;logps&#39; typically representing per-token loss).</span>

<span class="sd">    Args:</span>
<span class="sd">        input_ids: Input token IDS (for Stage 0).</span>
<span class="sd">        hidden_states: Hidden states from previous stage (for Stage &gt; 0).</span>
<span class="sd">        position_ids: Positional indices for RoPE.</span>
<span class="sd">        hidden_states_snapshot: Intermediate state collector.</span>
<span class="sd">        hidden_states_agg_mask: Mask for state aggregation.</span>
<span class="sd">        labels: Target tokens for loss computation (Last Stage).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing &#39;hidden_states&#39;, optionally &#39;hidden_states_snapshot&#39;,</span>
<span class="sd">        and per-token &#39;logps&#39; if on the last stage.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
        <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
        <span class="n">hidden_states</span><span class="o">=</span><span class="n">hidden_states</span><span class="p">,</span>
        <span class="n">position_ids</span><span class="o">=</span><span class="n">position_ids</span><span class="p">,</span>
        <span class="n">hidden_states_snapshot</span><span class="o">=</span><span class="n">hidden_states_snapshot</span><span class="p">,</span>
        <span class="n">hidden_states_agg_mask</span><span class="o">=</span><span class="n">hidden_states_agg_mask</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
        <span class="n">lm_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span><span class="p">(</span><span class="n">hidden_states</span><span class="o">=</span><span class="n">model_outputs</span><span class="p">[</span><span class="s2">&quot;hidden_states&quot;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">model_outputs</span><span class="p">[</span><span class="s2">&quot;logps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm_out</span>
    <span class="k">return</span> <span class="n">model_outputs</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEForCausalLM.reset_moe_stats" class="doc doc-heading">
            <code class=" language-python"><span class="n">reset_moe_stats</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Resets MoE routing statistics in the backbone.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset_moe_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resets MoE routing statistics in the backbone.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reset_moe_stats</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEForCausalLM.reset_parameters" class="doc doc-heading">
            <code class=" language-python"><span class="n">reset_parameters</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Resets module parameters.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resets module parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="d9d.module.model.qwen3_moe.Qwen3MoEForCausalLMParameters" class="doc doc-heading">
            <code>Qwen3MoEForCausalLMParameters</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>



        <p>Configuration parameters for Qwen3 Mixture-of-Experts model with a Causal Language Modeling head.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoEForCausalLMParameters.model">model</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Qwen3MoEParameters (d9d.module.model.qwen3_moe.params.Qwen3MoEParameters)" href="#d9d.module.model.qwen3_moe.Qwen3MoEParameters">Qwen3MoEParameters</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The configuration for the underlying Qwen3 MoE model.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table></div>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>d9d/module/model/qwen3_moe/params.py</code></summary>
                <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Qwen3MoEForCausalLMParameters</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configuration parameters for Qwen3 Mixture-of-Experts model with a Causal Language Modeling head.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        model: The configuration for the underlying Qwen3 MoE model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span><span class="p">:</span> <span class="n">Qwen3MoEParameters</span>
</code></pre></div></td></tr></table></div></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="d9d.module.model.qwen3_moe.Qwen3MoEForClassification" class="doc doc-heading">
            <code>Qwen3MoEForClassification</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code>, <code><a class="autorefs autorefs-internal" title="ModuleLateInit (d9d.module.base.ModuleLateInit)" href="../1_model_design/#d9d.module.base.ModuleLateInit">ModuleLateInit</a></code>, <code><a class="autorefs autorefs-internal" title="ModuleSupportsPipelining (d9d.pipelining.api.ModuleSupportsPipelining)" href="../3_pipeline_parallelism/#d9d.pipelining.api.ModuleSupportsPipelining">ModuleSupportsPipelining</a></code></p>



        <p>A Qwen3 MoE model wrapped with a Sequence/Token Classification head.</p>
<p>It is designed to be split across multiple pipeline stages.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
                <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Qwen3MoEForClassification</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">ModuleLateInit</span><span class="p">,</span> <span class="n">ModuleSupportsPipelining</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Qwen3 MoE model wrapped with a Sequence/Token Classification head.</span>

<span class="sd">    It is designed to be split across multiple pipeline stages.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Qwen3MoEForClassificationParameters</span><span class="p">,</span>
        <span class="n">stage</span><span class="p">:</span> <span class="n">PipelineStageInfo</span><span class="p">,</span>
        <span class="n">hidden_states_snapshot_mode</span><span class="p">:</span> <span class="n">HiddenStatesAggregationMode</span><span class="p">,</span>
        <span class="n">enable_checkpointing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the Qwen3MoEForClassification object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params: Full model configuration parameters.</span>
<span class="sd">            stage: Pipeline stage information for this instance.</span>
<span class="sd">            hidden_states_snapshot_mode: Configures intermediate hidden state aggregation &amp; snapshotting mode.</span>
<span class="sd">            enable_checkpointing: Whether to enable activation checkpointing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Qwen3MoEModel</span><span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">stage</span><span class="p">,</span>
            <span class="n">hidden_states_snapshot_mode</span><span class="o">=</span><span class="n">hidden_states_snapshot_mode</span><span class="p">,</span>
            <span class="n">enable_checkpointing</span><span class="o">=</span><span class="n">enable_checkpointing</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls_head</span> <span class="o">=</span> <span class="n">ClassificationHead</span><span class="p">(</span>
                <span class="n">hidden_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
                <span class="n">num_labels</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">num_labels</span><span class="p">,</span>
                <span class="n">dropout</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">classifier_dropout</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span> <span class="o">=</span> <span class="n">stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_size</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_labels</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">num_labels</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hidden_states</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">position_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hidden_states_snapshot</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hidden_states_agg_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pooling_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the classification model forward pass.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids: Input token IDS (for Stage 0).</span>
<span class="sd">            hidden_states: Hidden states from previous stage (for Stage &gt; 0).</span>
<span class="sd">            position_ids: Positional indices for RoPE.</span>
<span class="sd">            hidden_states_snapshot: Intermediate state collector.</span>
<span class="sd">            hidden_states_agg_mask: Mask for state aggregation.</span>
<span class="sd">            pooling_mask: Binary mask indicating which token(s) to pool for classification.</span>
<span class="sd">                Note: you can use `d9d.dataset.token_pooling_mask_from_attention_mask`</span>
<span class="sd">                in your Dataset to preallocate the pooling mask from attention mask.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing &#39;hidden_states&#39;, optionally &#39;hidden_states_snapshot&#39;.</span>
<span class="sd">                If on the last stage, also contains &#39;scores&#39; (logits) of shape [batch, num_labels].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">model_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
            <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
            <span class="n">hidden_states</span><span class="o">=</span><span class="n">hidden_states</span><span class="p">,</span>
            <span class="n">position_ids</span><span class="o">=</span><span class="n">position_ids</span><span class="p">,</span>
            <span class="n">hidden_states_snapshot</span><span class="o">=</span><span class="n">hidden_states_snapshot</span><span class="p">,</span>
            <span class="n">hidden_states_agg_mask</span><span class="o">=</span><span class="n">hidden_states_agg_mask</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
            <span class="n">model_outputs</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_head</span><span class="p">(</span>
                <span class="n">hidden_states</span><span class="o">=</span><span class="n">model_outputs</span><span class="p">[</span><span class="s2">&quot;hidden_states&quot;</span><span class="p">],</span> <span class="n">pooling_mask</span><span class="o">=</span><span class="n">pooling_mask</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">model_outputs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets module parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls_head</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_moe_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets MoE routing statistics in the backbone.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reset_moe_stats</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">moe_tokens_per_expert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Accesses MoE routing statistics from the backbone.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">moe_tokens_per_expert</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">infer_stage_inputs_from_pipeline_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">n_microbatches</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">infer_stage_inputs_from_pipeline_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">n_microbatches</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">infer_stage_outputs_from_pipeline_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">n_microbatches</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">pp_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">infer_stage_outputs_from_pipeline_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">n_microbatches</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">n_microbatches</span>
            <span class="n">pp_outputs</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_labels</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pp_outputs</span>
</code></pre></div></td></tr></table></div></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEForClassification.moe_tokens_per_expert" class="doc doc-heading">
            <code class=" language-python"><span class="n">moe_tokens_per_expert</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Accesses MoE routing statistics from the backbone.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEForClassification.__init__" class="doc doc-heading">
            <code class=" language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">hidden_states_snapshot_mode</span><span class="p">,</span> <span class="n">enable_checkpointing</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Constructs the Qwen3MoEForClassification object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>params</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Qwen3MoEForClassificationParameters (d9d.module.model.qwen3_moe.params.Qwen3MoEForClassificationParameters)" href="#d9d.module.model.qwen3_moe.Qwen3MoEForClassificationParameters">Qwen3MoEForClassificationParameters</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Full model configuration parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stage</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PipelineStageInfo


  
      dataclass
   (d9d.pipelining.api.PipelineStageInfo)" href="../3_pipeline_parallelism/#d9d.pipelining.api.PipelineStageInfo">PipelineStageInfo</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pipeline stage information for this instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states_snapshot_mode</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="HiddenStatesAggregationMode (d9d.module.block.hidden_states_aggregator.HiddenStatesAggregationMode)" href="../../modules/hidden_states_aggregator/#d9d.module.block.hidden_states_aggregator.HiddenStatesAggregationMode">HiddenStatesAggregationMode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configures intermediate hidden state aggregation &amp; snapshotting mode.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_checkpointing</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable activation checkpointing.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Qwen3MoEForClassificationParameters</span><span class="p">,</span>
    <span class="n">stage</span><span class="p">:</span> <span class="n">PipelineStageInfo</span><span class="p">,</span>
    <span class="n">hidden_states_snapshot_mode</span><span class="p">:</span> <span class="n">HiddenStatesAggregationMode</span><span class="p">,</span>
    <span class="n">enable_checkpointing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs the Qwen3MoEForClassification object.</span>

<span class="sd">    Args:</span>
<span class="sd">        params: Full model configuration parameters.</span>
<span class="sd">        stage: Pipeline stage information for this instance.</span>
<span class="sd">        hidden_states_snapshot_mode: Configures intermediate hidden state aggregation &amp; snapshotting mode.</span>
<span class="sd">        enable_checkpointing: Whether to enable activation checkpointing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Qwen3MoEModel</span><span class="p">(</span>
        <span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
        <span class="n">stage</span><span class="p">,</span>
        <span class="n">hidden_states_snapshot_mode</span><span class="o">=</span><span class="n">hidden_states_snapshot_mode</span><span class="p">,</span>
        <span class="n">enable_checkpointing</span><span class="o">=</span><span class="n">enable_checkpointing</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls_head</span> <span class="o">=</span> <span class="n">ClassificationHead</span><span class="p">(</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">num_labels</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">num_labels</span><span class="p">,</span>
            <span class="n">dropout</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">classifier_dropout</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span> <span class="o">=</span> <span class="n">stage</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_size</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_labels</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">num_labels</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEForClassification.forward" class="doc doc-heading">
            <code class=" language-python"><span class="n">forward</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden_states</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden_states_snapshot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden_states_agg_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pooling_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Executes the classification model forward pass.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_ids</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input token IDS (for Stage 0).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hidden states from previous stage (for Stage &gt; 0).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>position_ids</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positional indices for RoPE.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states_snapshot</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Intermediate state collector.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states_agg_mask</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mask for state aggregation.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pooling_mask</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Binary mask indicating which token(s) to pool for classification.
Note: you can use <code>d9d.dataset.token_pooling_mask_from_attention_mask</code>
in your Dataset to preallocate the pooling mask from attention mask.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table></div>


    <p><span class="doc-section-title">Returns:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing 'hidden_states', optionally 'hidden_states_snapshot'.
If on the last stage, also contains 'scores' (logits) of shape [batch, num_labels].</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hidden_states</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">position_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hidden_states_snapshot</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hidden_states_agg_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pooling_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the classification model forward pass.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_ids: Input token IDS (for Stage 0).</span>
<span class="sd">        hidden_states: Hidden states from previous stage (for Stage &gt; 0).</span>
<span class="sd">        position_ids: Positional indices for RoPE.</span>
<span class="sd">        hidden_states_snapshot: Intermediate state collector.</span>
<span class="sd">        hidden_states_agg_mask: Mask for state aggregation.</span>
<span class="sd">        pooling_mask: Binary mask indicating which token(s) to pool for classification.</span>
<span class="sd">            Note: you can use `d9d.dataset.token_pooling_mask_from_attention_mask`</span>
<span class="sd">            in your Dataset to preallocate the pooling mask from attention mask.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing &#39;hidden_states&#39;, optionally &#39;hidden_states_snapshot&#39;.</span>
<span class="sd">            If on the last stage, also contains &#39;scores&#39; (logits) of shape [batch, num_labels].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
        <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
        <span class="n">hidden_states</span><span class="o">=</span><span class="n">hidden_states</span><span class="p">,</span>
        <span class="n">position_ids</span><span class="o">=</span><span class="n">position_ids</span><span class="p">,</span>
        <span class="n">hidden_states_snapshot</span><span class="o">=</span><span class="n">hidden_states_snapshot</span><span class="p">,</span>
        <span class="n">hidden_states_agg_mask</span><span class="o">=</span><span class="n">hidden_states_agg_mask</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
        <span class="n">model_outputs</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_head</span><span class="p">(</span>
            <span class="n">hidden_states</span><span class="o">=</span><span class="n">model_outputs</span><span class="p">[</span><span class="s2">&quot;hidden_states&quot;</span><span class="p">],</span> <span class="n">pooling_mask</span><span class="o">=</span><span class="n">pooling_mask</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">model_outputs</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEForClassification.reset_moe_stats" class="doc doc-heading">
            <code class=" language-python"><span class="n">reset_moe_stats</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Resets MoE routing statistics in the backbone.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset_moe_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resets MoE routing statistics in the backbone.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reset_moe_stats</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEForClassification.reset_parameters" class="doc doc-heading">
            <code class=" language-python"><span class="n">reset_parameters</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Resets module parameters.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resets module parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls_head</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="d9d.module.model.qwen3_moe.Qwen3MoEForClassificationParameters" class="doc doc-heading">
            <code>Qwen3MoEForClassificationParameters</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>



        <p>Configuration parameters for Qwen3 Mixture-of-Experts model with a token/sequnce classification head.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoEForClassificationParameters.model">model</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Qwen3MoEParameters (d9d.module.model.qwen3_moe.params.Qwen3MoEParameters)" href="#d9d.module.model.qwen3_moe.Qwen3MoEParameters">Qwen3MoEParameters</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The configuration for the underlying Qwen3 MoE model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoEForClassificationParameters.num_labels">num_labels</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of output labels for classification.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoEForClassificationParameters.classifier_dropout">classifier_dropout</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dropout probability for the classification head.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table></div>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>d9d/module/model/qwen3_moe/params.py</code></summary>
                <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Qwen3MoEForClassificationParameters</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configuration parameters for Qwen3 Mixture-of-Experts model with a token/sequnce classification head.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        model: The configuration for the underlying Qwen3 MoE model.</span>
<span class="sd">        num_labels: The number of output labels for classification.</span>
<span class="sd">        classifier_dropout: The dropout probability for the classification head.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span><span class="p">:</span> <span class="n">Qwen3MoEParameters</span>
    <span class="n">num_labels</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">classifier_dropout</span><span class="p">:</span> <span class="nb">float</span>
</code></pre></div></td></tr></table></div></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="d9d.module.model.qwen3_moe.Qwen3MoELayer" class="doc doc-heading">
            <code>Qwen3MoELayer</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code>, <code><a class="autorefs autorefs-internal" title="ModuleLateInit (d9d.module.base.ModuleLateInit)" href="../1_model_design/#d9d.module.base.ModuleLateInit">ModuleLateInit</a></code></p>



        <p>Implements a single Qwen3 Mixture-of-Experts (MoE) transformer layer.</p>
<p>This layer consists of a Grouped Query Attention mechanism followed by an MoE
MLP block, with pre-RMSNorm applied before each sub-layer.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>d9d/module/model/qwen3_moe/decoder_layer.py</code></summary>
                <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Qwen3MoELayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">ModuleLateInit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements a single Qwen3 Mixture-of-Experts (MoE) transformer layer.</span>

<span class="sd">    This layer consists of a Grouped Query Attention mechanism followed by an MoE</span>
<span class="sd">    MLP block, with pre-RMSNorm applied before each sub-layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Qwen3MoELayerParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a Qwen3MoELayer object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params: Configuration parameters for the layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span> <span class="o">=</span> <span class="n">GroupedQueryAttention</span><span class="p">(</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">num_attention_heads</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">num_attention_heads</span><span class="p">,</span>
            <span class="n">num_key_value_heads</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">num_key_value_heads</span><span class="p">,</span>
            <span class="n">is_causal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">qk_norm_eps</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">rms_norm_eps</span><span class="p">,</span>
            <span class="n">head_dim</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">MoELayer</span><span class="p">(</span>
            <span class="n">hidden_dim</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">num_grouped_experts</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">num_experts</span><span class="p">,</span>
            <span class="n">intermediate_dim_grouped</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">intermediate_size</span><span class="p">,</span>
            <span class="n">top_k</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">experts_top_k</span><span class="p">,</span>
            <span class="n">router_renormalize_probabilities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_layernorm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">RMSNorm</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">rms_norm_eps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_attention_layernorm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">RMSNorm</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">rms_norm_eps</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">hidden_states</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">position_embeddings</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs the forward pass of the MoE layer.</span>

<span class="sd">        Args:</span>
<span class="sd">            hidden_states: Input tensor of shape `(batch, seq_len, hidden_dim)`.</span>
<span class="sd">            position_embeddings: Tuple containing RoPE precomputed embeddings (cos, sin).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Output tensor after attention and MoE blocks, shape `(batch, seq_len, hidden_dim)`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">residual</span> <span class="o">=</span> <span class="n">hidden_states</span>

        <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_layernorm</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>

        <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span><span class="p">(</span>
            <span class="n">hidden_states</span><span class="o">=</span><span class="n">hidden_states</span><span class="p">,</span>
            <span class="n">position_embeddings</span><span class="o">=</span><span class="n">position_embeddings</span><span class="p">,</span>
            <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># no mask for moe decoder</span>
        <span class="p">)</span>
        <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">residual</span> <span class="o">+</span> <span class="n">hidden_states</span>

        <span class="n">residual</span> <span class="o">=</span> <span class="n">hidden_states</span>
        <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_attention_layernorm</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>
        <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>

        <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">residual</span> <span class="o">+</span> <span class="n">hidden_states</span>

        <span class="k">return</span> <span class="n">hidden_states</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_moe_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets statistical counters inside the MoE router (e.g., token counts per expert).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="o">.</span><span class="n">reset_stats</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">moe_tokens_per_expert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of tokens routed to each expert.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="o">.</span><span class="n">tokens_per_expert</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets module parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_layernorm</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_attention_layernorm</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="d9d.module.model.qwen3_moe.Qwen3MoELayer.moe_tokens_per_expert" class="doc doc-heading">
            <code class=" language-python"><span class="n">moe_tokens_per_expert</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Returns the number of tokens routed to each expert.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoELayer.__init__" class="doc doc-heading">
            <code class=" language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Constructs a Qwen3MoELayer object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>params</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Qwen3MoELayerParameters (d9d.module.model.qwen3_moe.params.Qwen3MoELayerParameters)" href="#d9d.module.model.qwen3_moe.Qwen3MoELayerParameters">Qwen3MoELayerParameters</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration parameters for the layer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/decoder_layer.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Qwen3MoELayerParameters</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs a Qwen3MoELayer object.</span>

<span class="sd">    Args:</span>
<span class="sd">        params: Configuration parameters for the layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span> <span class="o">=</span> <span class="n">GroupedQueryAttention</span><span class="p">(</span>
        <span class="n">hidden_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">num_attention_heads</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">num_attention_heads</span><span class="p">,</span>
        <span class="n">num_key_value_heads</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">num_key_value_heads</span><span class="p">,</span>
        <span class="n">is_causal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">qk_norm_eps</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">rms_norm_eps</span><span class="p">,</span>
        <span class="n">head_dim</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">MoELayer</span><span class="p">(</span>
        <span class="n">hidden_dim</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">num_grouped_experts</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">num_experts</span><span class="p">,</span>
        <span class="n">intermediate_dim_grouped</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">intermediate_size</span><span class="p">,</span>
        <span class="n">top_k</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">experts_top_k</span><span class="p">,</span>
        <span class="n">router_renormalize_probabilities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">input_layernorm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">RMSNorm</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">rms_norm_eps</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_attention_layernorm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">RMSNorm</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">rms_norm_eps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoELayer.forward" class="doc doc-heading">
            <code class=" language-python"><span class="n">forward</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">position_embeddings</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Performs the forward pass of the MoE layer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input tensor of shape <code>(batch, seq_len, hidden_dim)</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>position_embeddings</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="torch.Tensor">Tensor</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple containing RoPE precomputed embeddings (cos, sin).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table></div>


    <p><span class="doc-section-title">Returns:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output tensor after attention and MoE blocks, shape <code>(batch, seq_len, hidden_dim)</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/decoder_layer.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">hidden_states</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">position_embeddings</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs the forward pass of the MoE layer.</span>

<span class="sd">    Args:</span>
<span class="sd">        hidden_states: Input tensor of shape `(batch, seq_len, hidden_dim)`.</span>
<span class="sd">        position_embeddings: Tuple containing RoPE precomputed embeddings (cos, sin).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Output tensor after attention and MoE blocks, shape `(batch, seq_len, hidden_dim)`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">residual</span> <span class="o">=</span> <span class="n">hidden_states</span>

    <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_layernorm</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>

    <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span><span class="p">(</span>
        <span class="n">hidden_states</span><span class="o">=</span><span class="n">hidden_states</span><span class="p">,</span>
        <span class="n">position_embeddings</span><span class="o">=</span><span class="n">position_embeddings</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># no mask for moe decoder</span>
    <span class="p">)</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">residual</span> <span class="o">+</span> <span class="n">hidden_states</span>

    <span class="n">residual</span> <span class="o">=</span> <span class="n">hidden_states</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_attention_layernorm</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>

    <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">residual</span> <span class="o">+</span> <span class="n">hidden_states</span>

    <span class="k">return</span> <span class="n">hidden_states</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoELayer.reset_moe_stats" class="doc doc-heading">
            <code class=" language-python"><span class="n">reset_moe_stats</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Resets statistical counters inside the MoE router (e.g., token counts per expert).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/decoder_layer.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset_moe_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resets statistical counters inside the MoE router (e.g., token counts per expert).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="o">.</span><span class="n">reset_stats</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoELayer.reset_parameters" class="doc doc-heading">
            <code class=" language-python"><span class="n">reset_parameters</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Resets module parameters.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/decoder_layer.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resets module parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_layernorm</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_attention_layernorm</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="d9d.module.model.qwen3_moe.Qwen3MoELayerParameters" class="doc doc-heading">
            <code>Qwen3MoELayerParameters</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>



        <p>Configuration parameters for a single Qwen3 MoE layer.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoELayerParameters.hidden_size">hidden_size</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dimension of the model's hidden states.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoELayerParameters.intermediate_size">intermediate_size</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dimension of the feed-forward hidden state.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoELayerParameters.num_experts">num_experts</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total number of experts in the MoE layer.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoELayerParameters.experts_top_k">experts_top_k</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of experts to route tokens to.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoELayerParameters.num_attention_heads">num_attention_heads</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of attention heads for the query.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoELayerParameters.num_key_value_heads">num_key_value_heads</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of attention heads for key and value.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoELayerParameters.rms_norm_eps">rms_norm_eps</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Epsilon value found in the RMSNorm layers.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoELayerParameters.head_dim">head_dim</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dimension of a single attention head.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table></div>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>d9d/module/model/qwen3_moe/params.py</code></summary>
                <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Qwen3MoELayerParameters</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configuration parameters for a single Qwen3 MoE layer.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        hidden_size: Dimension of the model&#39;s hidden states.</span>
<span class="sd">        intermediate_size: Dimension of the feed-forward hidden state.</span>
<span class="sd">        num_experts: Total number of experts in the MoE layer.</span>
<span class="sd">        experts_top_k: Number of experts to route tokens to.</span>
<span class="sd">        num_attention_heads: Number of attention heads for the query.</span>
<span class="sd">        num_key_value_heads: Number of attention heads for key and value.</span>
<span class="sd">        rms_norm_eps: Epsilon value found in the RMSNorm layers.</span>
<span class="sd">        head_dim: Dimension of a single attention head.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">intermediate_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_experts</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">experts_top_k</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_attention_heads</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_key_value_heads</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">rms_norm_eps</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">head_dim</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div></td></tr></table></div></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="d9d.module.model.qwen3_moe.Qwen3MoEModel" class="doc doc-heading">
            <code>Qwen3MoEModel</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code>, <code><a class="autorefs autorefs-internal" title="ModuleLateInit (d9d.module.base.ModuleLateInit)" href="../1_model_design/#d9d.module.base.ModuleLateInit">ModuleLateInit</a></code>, <code><a class="autorefs autorefs-internal" title="ModuleSupportsPipelining (d9d.pipelining.api.ModuleSupportsPipelining)" href="../3_pipeline_parallelism/#d9d.pipelining.api.ModuleSupportsPipelining">ModuleSupportsPipelining</a></code></p>



        <p>The Qwen3 Mixture-of-Experts (MoE) Transformer Decoder backbone.</p>
<p>It is designed to be split across multiple pipeline stages.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
                <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Qwen3MoEModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">ModuleLateInit</span><span class="p">,</span> <span class="n">ModuleSupportsPipelining</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Qwen3 Mixture-of-Experts (MoE) Transformer Decoder backbone.</span>

<span class="sd">    It is designed to be split across multiple pipeline stages.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Qwen3MoEParameters</span><span class="p">,</span>
        <span class="n">stage</span><span class="p">:</span> <span class="n">PipelineStageInfo</span><span class="p">,</span>
        <span class="n">hidden_states_snapshot_mode</span><span class="p">:</span> <span class="n">HiddenStatesAggregationMode</span><span class="p">,</span>
        <span class="n">enable_checkpointing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the Qwen3MoEModel object.</span>

<span class="sd">        Args:</span>
<span class="sd">            params: Configuration parameters for the full model.</span>
<span class="sd">            stage: Information about the pipeline stage this instance belongs to.</span>
<span class="sd">            hidden_states_snapshot_mode: Configures intermediate hidden state aggregation &amp; snapshotting mode</span>
<span class="sd">            enable_checkpointing: If True, enables activation checkpointing for transformer layers to save memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_current_stage_first</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_tokens</span> <span class="o">=</span> <span class="n">SplitTokenEmbeddings</span><span class="p">(</span>
                <span class="n">hidden_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
                <span class="n">split_vocab_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">split_vocab_size</span><span class="p">,</span>
                <span class="n">split_order</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">split_vocab_order</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># we use ModuleDict here to properly handle pipelining and loading weights after the model</span>
        <span class="c1"># was pipelined</span>
        <span class="n">layer_start</span><span class="p">,</span> <span class="n">layer_end</span> <span class="o">=</span> <span class="n">distribute_layers_for_pipeline_stage</span><span class="p">(</span>
            <span class="n">num_layers</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">num_hidden_layers</span><span class="p">,</span>
            <span class="n">num_virtual_layers_pre</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">pipeline_num_virtual_layers_pre</span><span class="p">,</span>  <span class="c1"># embeddings</span>
            <span class="n">num_virtual_layers_post</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">pipeline_num_virtual_layers_post</span><span class="p">,</span>  <span class="c1"># LM head</span>
            <span class="n">stage</span><span class="o">=</span><span class="n">stage</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_num_layers_before</span> <span class="o">=</span> <span class="n">layer_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_start</span><span class="p">,</span> <span class="n">layer_end</span><span class="p">)))</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">):</span> <span class="n">Qwen3MoELayer</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Qwen3MoELayer</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Qwen3MoELayer</span><span class="p">],</span> <span class="n">layers</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rope_provider</span> <span class="o">=</span> <span class="n">RotaryEmbeddingProvider</span><span class="p">(</span>
            <span class="n">max_position_ids</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">max_position_ids</span><span class="p">,</span> <span class="n">rope_base</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">rope_base</span><span class="p">,</span> <span class="n">head_dim</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">head_dim</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">RMSNorm</span><span class="p">(</span><span class="n">normalized_shape</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">rms_norm_eps</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span> <span class="o">=</span> <span class="n">stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_states_snapshot_mode</span> <span class="o">=</span> <span class="n">hidden_states_snapshot_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_size</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_checkpointing</span> <span class="o">=</span> <span class="n">enable_checkpointing</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">output_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the data type of the model output hidden states.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">input_layernorm</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">dtype</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hidden_states</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">position_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hidden_states_snapshot</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hidden_states_agg_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the forward pass for the current pipeline stage.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids: Indices of input sequence tokens. Required if this is the</span>
<span class="sd">                first pipeline stage.</span>
<span class="sd">            hidden_states: Hidden states from the previous pipeline stage. Required</span>
<span class="sd">                if this is not the first pipeline stage.</span>
<span class="sd">            position_ids: Indices of positions of each input sequence tokens in the</span>
<span class="sd">                position embeddings.</span>
<span class="sd">            hidden_states_snapshot: Accumulated tensor of aggregated hidden states</span>
<span class="sd">                from previous stages. Used if snapshotting is enabled.</span>
<span class="sd">            hidden_states_agg_mask: Mask used to aggregate hidden states for</span>
<span class="sd">                snapshots.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary containing:</span>
<span class="sd">                *   &#39;hidden_states&#39;: The output of the last layer in this stage.</span>
<span class="sd">                *   &#39;hidden_states_snapshot&#39;: (Optional) The updated snapshot tensor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_aggregator</span> <span class="o">=</span> <span class="n">create_hidden_states_aggregator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hidden_states_snapshot_mode</span><span class="p">,</span> <span class="n">hidden_states_agg_mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">last_hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_tokens</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
            <span class="n">state_aggregator</span><span class="o">.</span><span class="n">add_hidden_states</span><span class="p">(</span><span class="n">last_hidden_states</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_hidden_states</span> <span class="o">=</span> <span class="n">hidden_states</span>

        <span class="n">rope_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rope_provider</span><span class="p">(</span><span class="n">position_ids</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">decoder_layer_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span><span class="p">:</span>
            <span class="n">decoder_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">decoder_layer_name</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_checkpointing</span><span class="p">:</span>
                <span class="n">last_hidden_states</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">(</span><span class="n">decoder_layer</span><span class="p">,</span> <span class="n">last_hidden_states</span><span class="p">,</span> <span class="n">rope_params</span><span class="p">,</span> <span class="n">use_reentrant</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">last_hidden_states</span> <span class="o">=</span> <span class="n">decoder_layer</span><span class="p">(</span><span class="n">last_hidden_states</span><span class="p">,</span> <span class="n">rope_params</span><span class="p">)</span>

            <span class="n">state_aggregator</span><span class="o">.</span><span class="n">add_hidden_states</span><span class="p">(</span><span class="n">last_hidden_states</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
            <span class="n">last_hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">last_hidden_states</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;hidden_states&quot;</span><span class="p">:</span> <span class="n">last_hidden_states</span><span class="p">,</span>
            <span class="s2">&quot;hidden_states_snapshot&quot;</span><span class="p">:</span> <span class="n">state_aggregator</span><span class="o">.</span><span class="n">pack_with_snapshot</span><span class="p">(</span><span class="n">hidden_states_snapshot</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_moe_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets routing statistics for all MoE layers in this stage.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span><span class="o">.</span><span class="n">reset_moe_stats</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">moe_tokens_per_expert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the number of tokens routed to each expert across all layers.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tensor of shape (num_local_layers, num_experts) containing counts.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span><span class="o">.</span><span class="n">moe_tokens_per_expert</span> <span class="k">for</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resets module parameters&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_first</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_tokens</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rope_provider</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">decoder_layer_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span><span class="p">:</span>
            <span class="n">decoder_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">decoder_layer_name</span><span class="p">]</span>
            <span class="n">decoder_layer</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">infer_stage_inputs_from_pipeline_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">n_microbatches</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>

        <span class="n">pp_inputs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># for calculation - input ids or prev hidden state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_first</span><span class="p">:</span>
            <span class="n">pp_inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                <span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">n_microbatches</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pp_inputs</span><span class="p">[</span><span class="s2">&quot;hidden_states&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                <span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">n_microbatches</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_size</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dtype</span><span class="p">(),</span>
                <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_states_snapshot_mode</span> <span class="o">!=</span> <span class="n">HiddenStatesAggregationMode</span><span class="o">.</span><span class="n">no</span><span class="p">:</span>
                <span class="n">num_layers_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_layers_before</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># 1 for embedding</span>
                <span class="n">pp_inputs</span><span class="p">[</span><span class="s2">&quot;hidden_states_snapshot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">num_layers_before</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">n_microbatches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_size</span><span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dtype</span><span class="p">(),</span>
                    <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">pp_inputs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">infer_stage_outputs_from_pipeline_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">n_microbatches</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>

        <span class="c1"># for calculation - last hidden state</span>
        <span class="n">pp_outputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;hidden_states&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                <span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">n_microbatches</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_size</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dtype</span><span class="p">(),</span>
                <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># for state caching</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_states_snapshot_mode</span> <span class="o">!=</span> <span class="n">HiddenStatesAggregationMode</span><span class="o">.</span><span class="n">no</span><span class="p">:</span>
            <span class="n">num_layers_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_layers_before</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">num_layers_current</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
            <span class="n">num_layers_after</span> <span class="o">=</span> <span class="n">num_layers_before</span> <span class="o">+</span> <span class="n">num_layers_current</span>
            <span class="n">pp_outputs</span><span class="p">[</span><span class="s2">&quot;hidden_states_snapshot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                <span class="p">(</span><span class="n">num_layers_after</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">n_microbatches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_size</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dtype</span><span class="p">(),</span>
                <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">pp_outputs</span>
</code></pre></div></td></tr></table></div></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEModel.moe_tokens_per_expert" class="doc doc-heading">
            <code class=" language-python"><span class="n">moe_tokens_per_expert</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Retrieves the number of tokens routed to each expert across all layers.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tensor of shape (num_local_layers, num_experts) containing counts.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table></div>

    </div>

</div>




<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEModel.__init__" class="doc doc-heading">
            <code class=" language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">hidden_states_snapshot_mode</span><span class="p">,</span> <span class="n">enable_checkpointing</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Constructs the Qwen3MoEModel object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>params</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Qwen3MoEParameters (d9d.module.model.qwen3_moe.params.Qwen3MoEParameters)" href="#d9d.module.model.qwen3_moe.Qwen3MoEParameters">Qwen3MoEParameters</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration parameters for the full model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stage</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PipelineStageInfo


  
      dataclass
   (d9d.pipelining.api.PipelineStageInfo)" href="../3_pipeline_parallelism/#d9d.pipelining.api.PipelineStageInfo">PipelineStageInfo</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Information about the pipeline stage this instance belongs to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states_snapshot_mode</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="HiddenStatesAggregationMode (d9d.module.block.hidden_states_aggregator.HiddenStatesAggregationMode)" href="../../modules/hidden_states_aggregator/#d9d.module.block.hidden_states_aggregator.HiddenStatesAggregationMode">HiddenStatesAggregationMode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configures intermediate hidden state aggregation &amp; snapshotting mode</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_checkpointing</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, enables activation checkpointing for transformer layers to save memory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Qwen3MoEParameters</span><span class="p">,</span>
    <span class="n">stage</span><span class="p">:</span> <span class="n">PipelineStageInfo</span><span class="p">,</span>
    <span class="n">hidden_states_snapshot_mode</span><span class="p">:</span> <span class="n">HiddenStatesAggregationMode</span><span class="p">,</span>
    <span class="n">enable_checkpointing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs the Qwen3MoEModel object.</span>

<span class="sd">    Args:</span>
<span class="sd">        params: Configuration parameters for the full model.</span>
<span class="sd">        stage: Information about the pipeline stage this instance belongs to.</span>
<span class="sd">        hidden_states_snapshot_mode: Configures intermediate hidden state aggregation &amp; snapshotting mode</span>
<span class="sd">        enable_checkpointing: If True, enables activation checkpointing for transformer layers to save memory.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_current_stage_first</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_tokens</span> <span class="o">=</span> <span class="n">SplitTokenEmbeddings</span><span class="p">(</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">split_vocab_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">split_vocab_size</span><span class="p">,</span>
            <span class="n">split_order</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">split_vocab_order</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># we use ModuleDict here to properly handle pipelining and loading weights after the model</span>
    <span class="c1"># was pipelined</span>
    <span class="n">layer_start</span><span class="p">,</span> <span class="n">layer_end</span> <span class="o">=</span> <span class="n">distribute_layers_for_pipeline_stage</span><span class="p">(</span>
        <span class="n">num_layers</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">num_hidden_layers</span><span class="p">,</span>
        <span class="n">num_virtual_layers_pre</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">pipeline_num_virtual_layers_pre</span><span class="p">,</span>  <span class="c1"># embeddings</span>
        <span class="n">num_virtual_layers_post</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">pipeline_num_virtual_layers_post</span><span class="p">,</span>  <span class="c1"># LM head</span>
        <span class="n">stage</span><span class="o">=</span><span class="n">stage</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_num_layers_before</span> <span class="o">=</span> <span class="n">layer_start</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_start</span><span class="p">,</span> <span class="n">layer_end</span><span class="p">)))</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">):</span> <span class="n">Qwen3MoELayer</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span><span class="p">})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Qwen3MoELayer</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Qwen3MoELayer</span><span class="p">],</span> <span class="n">layers</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">rope_provider</span> <span class="o">=</span> <span class="n">RotaryEmbeddingProvider</span><span class="p">(</span>
        <span class="n">max_position_ids</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">max_position_ids</span><span class="p">,</span> <span class="n">rope_base</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">rope_base</span><span class="p">,</span> <span class="n">head_dim</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">head_dim</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">RMSNorm</span><span class="p">(</span><span class="n">normalized_shape</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">rms_norm_eps</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span> <span class="o">=</span> <span class="n">stage</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_states_snapshot_mode</span> <span class="o">=</span> <span class="n">hidden_states_snapshot_mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_size</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">hidden_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_enable_checkpointing</span> <span class="o">=</span> <span class="n">enable_checkpointing</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEModel.forward" class="doc doc-heading">
            <code class=" language-python"><span class="n">forward</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden_states</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden_states_snapshot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden_states_agg_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Executes the forward pass for the current pipeline stage.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_ids</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of input sequence tokens. Required if this is the
first pipeline stage.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hidden states from the previous pipeline stage. Required
if this is not the first pipeline stage.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>position_ids</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of positions of each input sequence tokens in the
position embeddings.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states_snapshot</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Accumulated tensor of aggregated hidden states
from previous stages. Used if snapshotting is enabled.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states_agg_mask</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mask used to aggregate hidden states for
snapshots.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table></div>


    <p><span class="doc-section-title">Returns:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="torch.Tensor">Tensor</span> | None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing:
*   'hidden_states': The output of the last layer in this stage.
*   'hidden_states_snapshot': (Optional) The updated snapshot tensor.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hidden_states</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">position_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hidden_states_snapshot</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hidden_states_agg_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the forward pass for the current pipeline stage.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_ids: Indices of input sequence tokens. Required if this is the</span>
<span class="sd">            first pipeline stage.</span>
<span class="sd">        hidden_states: Hidden states from the previous pipeline stage. Required</span>
<span class="sd">            if this is not the first pipeline stage.</span>
<span class="sd">        position_ids: Indices of positions of each input sequence tokens in the</span>
<span class="sd">            position embeddings.</span>
<span class="sd">        hidden_states_snapshot: Accumulated tensor of aggregated hidden states</span>
<span class="sd">            from previous stages. Used if snapshotting is enabled.</span>
<span class="sd">        hidden_states_agg_mask: Mask used to aggregate hidden states for</span>
<span class="sd">            snapshots.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary containing:</span>
<span class="sd">            *   &#39;hidden_states&#39;: The output of the last layer in this stage.</span>
<span class="sd">            *   &#39;hidden_states_snapshot&#39;: (Optional) The updated snapshot tensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state_aggregator</span> <span class="o">=</span> <span class="n">create_hidden_states_aggregator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hidden_states_snapshot_mode</span><span class="p">,</span> <span class="n">hidden_states_agg_mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">last_hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_tokens</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
        <span class="n">state_aggregator</span><span class="o">.</span><span class="n">add_hidden_states</span><span class="p">(</span><span class="n">last_hidden_states</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">last_hidden_states</span> <span class="o">=</span> <span class="n">hidden_states</span>

    <span class="n">rope_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rope_provider</span><span class="p">(</span><span class="n">position_ids</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">decoder_layer_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span><span class="p">:</span>
        <span class="n">decoder_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">decoder_layer_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_checkpointing</span><span class="p">:</span>
            <span class="n">last_hidden_states</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">(</span><span class="n">decoder_layer</span><span class="p">,</span> <span class="n">last_hidden_states</span><span class="p">,</span> <span class="n">rope_params</span><span class="p">,</span> <span class="n">use_reentrant</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_hidden_states</span> <span class="o">=</span> <span class="n">decoder_layer</span><span class="p">(</span><span class="n">last_hidden_states</span><span class="p">,</span> <span class="n">rope_params</span><span class="p">)</span>

        <span class="n">state_aggregator</span><span class="o">.</span><span class="n">add_hidden_states</span><span class="p">(</span><span class="n">last_hidden_states</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
        <span class="n">last_hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">last_hidden_states</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;hidden_states&quot;</span><span class="p">:</span> <span class="n">last_hidden_states</span><span class="p">,</span>
        <span class="s2">&quot;hidden_states_snapshot&quot;</span><span class="p">:</span> <span class="n">state_aggregator</span><span class="o">.</span><span class="n">pack_with_snapshot</span><span class="p">(</span><span class="n">hidden_states_snapshot</span><span class="p">),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEModel.output_dtype" class="doc doc-heading">
            <code class=" language-python"><span class="n">output_dtype</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Returns the data type of the model output hidden states.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">output_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the data type of the model output hidden states.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">input_layernorm</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">dtype</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEModel.reset_moe_stats" class="doc doc-heading">
            <code class=" language-python"><span class="n">reset_moe_stats</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Resets routing statistics for all MoE layers in this stage.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset_moe_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resets routing statistics for all MoE layers in this stage.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span><span class="o">.</span><span class="n">reset_moe_stats</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="d9d.module.model.qwen3_moe.Qwen3MoEModel.reset_parameters" class="doc doc-heading">
            <code class=" language-python"><span class="n">reset_parameters</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Resets module parameters</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/model/qwen3_moe/model.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resets module parameters&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_first</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_tokens</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">rope_provider</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">decoder_layer_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_iter</span><span class="p">:</span>
        <span class="n">decoder_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">decoder_layer_name</span><span class="p">]</span>
        <span class="n">decoder_layer</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="d9d.module.model.qwen3_moe.Qwen3MoEParameters" class="doc doc-heading">
            <code>Qwen3MoEParameters</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>



        <p>Configuration parameters for the Qwen3 Mixture-of-Experts model backbone.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoEParameters.layer">layer</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Qwen3MoELayerParameters (d9d.module.model.qwen3_moe.params.Qwen3MoELayerParameters)" href="#d9d.module.model.qwen3_moe.Qwen3MoELayerParameters">Qwen3MoELayerParameters</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration shared across all transformer layers.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoEParameters.num_hidden_layers">num_hidden_layers</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The total number of transformer layers.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoEParameters.rope_base">rope_base</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base value for RoPE frequency calculation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoEParameters.max_position_ids">max_position_ids</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum sequence length.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoEParameters.split_vocab_size">split_vocab_size</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping vocabulary segment names to their sizes.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoEParameters.split_vocab_order">split_vocab_order</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The sequence in which vocabulary splits are correctly ordered.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoEParameters.pipeline_num_virtual_layers_pre">pipeline_num_virtual_layers_pre</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of 'virtual' layers representing the
computational cost of modules on the <em>first</em> stage, before the main
layers (e.g., token and positional embeddings).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="d9d.module.model.qwen3_moe.Qwen3MoEParameters.pipeline_num_virtual_layers_post">pipeline_num_virtual_layers_post</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of 'virtual' layers representing the
computational cost of modules on the <em>last</em> stage, after the main
layers (e.g., the final layer normalization and LM head).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table></div>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>d9d/module/model/qwen3_moe/params.py</code></summary>
                <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Qwen3MoEParameters</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configuration parameters for the Qwen3 Mixture-of-Experts model backbone.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        layer: Configuration shared across all transformer layers.</span>
<span class="sd">        num_hidden_layers: The total number of transformer layers.</span>
<span class="sd">        rope_base: Base value for RoPE frequency calculation.</span>
<span class="sd">        max_position_ids: Maximum sequence length.</span>
<span class="sd">        split_vocab_size: A dictionary mapping vocabulary segment names to their sizes.</span>
<span class="sd">        split_vocab_order: The sequence in which vocabulary splits are correctly ordered.</span>
<span class="sd">        pipeline_num_virtual_layers_pre: The number of &#39;virtual&#39; layers representing the</span>
<span class="sd">            computational cost of modules on the *first* stage, before the main</span>
<span class="sd">            layers (e.g., token and positional embeddings).</span>
<span class="sd">        pipeline_num_virtual_layers_post: The number of &#39;virtual&#39; layers representing the</span>
<span class="sd">            computational cost of modules on the *last* stage, after the main</span>
<span class="sd">            layers (e.g., the final layer normalization and LM head).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">layer</span><span class="p">:</span> <span class="n">Qwen3MoELayerParameters</span>

    <span class="n">num_hidden_layers</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">rope_base</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">max_position_ids</span><span class="p">:</span> <span class="nb">int</span>

    <span class="n">split_vocab_size</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">split_vocab_order</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="n">pipeline_num_virtual_layers_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pipeline_num_virtual_layers_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="d9d.module.parallelism.model.qwen3_moe" class="doc doc-heading">
            <code>d9d.module.parallelism.model.qwen3_moe</code>


</h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="d9d.module.parallelism.model.qwen3_moe.parallelize_qwen3_moe_for_causal_lm" class="doc doc-heading">
            <code class=" language-python"><span class="n">parallelize_qwen3_moe_for_causal_lm</span><span class="p">(</span><span class="n">dist_context</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Parallelizes the Qwen3 MoE Causal LM model.</p>
<p>This function delegates backbone parallelization to <code>parallelize_qwen3_moe_model</code>
and additionally configures the language model head with Hybrid Sharded Data
Parallelism (HSDP).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dist_context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DistributedContext (d9d.core.dist_context.DistributedContext)" href="../../core/dist_context/#d9d.core.dist_context.DistributedContext">DistributedContext</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The distributed context containing device meshes and topology info.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Qwen3MoEForCausalLM (d9d.module.model.qwen3_moe.Qwen3MoEForCausalLM)" href="#d9d.module.model.qwen3_moe.Qwen3MoEForCausalLM">Qwen3MoEForCausalLM</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Qwen3 MoE Causal LM model to parallelize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stage</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PipelineStageInfo


  
      dataclass
   (d9d.pipelining.api.PipelineStageInfo)" href="../3_pipeline_parallelism/#d9d.pipelining.api.PipelineStageInfo">PipelineStageInfo</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Information about the current pipeline stage.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/parallelism/model/qwen3_moe.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parallelize_qwen3_moe_for_causal_lm</span><span class="p">(</span>
    <span class="n">dist_context</span><span class="p">:</span> <span class="n">DistributedContext</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Qwen3MoEForCausalLM</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">PipelineStageInfo</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parallelizes the Qwen3 MoE Causal LM model.</span>

<span class="sd">    This function delegates backbone parallelization to ``parallelize_qwen3_moe_model``</span>
<span class="sd">    and additionally configures the language model head with Hybrid Sharded Data</span>
<span class="sd">    Parallelism (HSDP).</span>

<span class="sd">    Args:</span>
<span class="sd">        dist_context: The distributed context containing device meshes and topology info.</span>
<span class="sd">        model: The Qwen3 MoE Causal LM model to parallelize.</span>
<span class="sd">        stage: Information about the current pipeline stage.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dense_mesh</span> <span class="o">=</span> <span class="n">dist_context</span><span class="o">.</span><span class="n">mesh_for</span><span class="p">(</span><span class="n">DENSE_DOMAIN</span><span class="p">)</span>

    <span class="n">parallelize_qwen3_moe_model</span><span class="p">(</span><span class="n">dist_context</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
        <span class="n">parallelize_hsdp</span><span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">lm_head</span><span class="p">,</span>
            <span class="n">mesh</span><span class="o">=</span><span class="n">dense_mesh</span><span class="p">[</span><span class="s2">&quot;dp_replicate&quot;</span><span class="p">,</span> <span class="s2">&quot;dp_cp_shard&quot;</span><span class="p">,</span> <span class="s2">&quot;cp_replicate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="d9d.module.parallelism.model.qwen3_moe.parallelize_qwen3_moe_for_classification" class="doc doc-heading">
            <code class=" language-python"><span class="n">parallelize_qwen3_moe_for_classification</span><span class="p">(</span><span class="n">dist_context</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Parallelizes the Qwen3 MoE classification model.</p>
<p>This function delegates backbone parallelization to <code>parallelize_qwen3_moe_model</code>
and additionally configures the classification head with Hybrid Sharded Data
Parallelism (HSDP).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dist_context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DistributedContext (d9d.core.dist_context.DistributedContext)" href="../../core/dist_context/#d9d.core.dist_context.DistributedContext">DistributedContext</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The distributed context containing device meshes and topology info.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Qwen3MoEForClassification (d9d.module.model.qwen3_moe.Qwen3MoEForClassification)" href="#d9d.module.model.qwen3_moe.Qwen3MoEForClassification">Qwen3MoEForClassification</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Qwen3 MoE classification model to parallelize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stage</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PipelineStageInfo


  
      dataclass
   (d9d.pipelining.api.PipelineStageInfo)" href="../3_pipeline_parallelism/#d9d.pipelining.api.PipelineStageInfo">PipelineStageInfo</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Information about the current pipeline stage.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/parallelism/model/qwen3_moe.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parallelize_qwen3_moe_for_classification</span><span class="p">(</span>
    <span class="n">dist_context</span><span class="p">:</span> <span class="n">DistributedContext</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Qwen3MoEForClassification</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">PipelineStageInfo</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parallelizes the Qwen3 MoE classification model.</span>

<span class="sd">    This function delegates backbone parallelization to ``parallelize_qwen3_moe_model``</span>
<span class="sd">    and additionally configures the classification head with Hybrid Sharded Data</span>
<span class="sd">    Parallelism (HSDP).</span>

<span class="sd">    Args:</span>
<span class="sd">        dist_context: The distributed context containing device meshes and topology info.</span>
<span class="sd">        model: The Qwen3 MoE classification model to parallelize.</span>
<span class="sd">        stage: Information about the current pipeline stage.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dense_mesh</span> <span class="o">=</span> <span class="n">dist_context</span><span class="o">.</span><span class="n">mesh_for</span><span class="p">(</span><span class="n">DENSE_DOMAIN</span><span class="p">)</span>

    <span class="n">parallelize_qwen3_moe_model</span><span class="p">(</span><span class="n">dist_context</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
        <span class="n">parallelize_hsdp</span><span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">cls_head</span><span class="p">,</span>
            <span class="n">mesh</span><span class="o">=</span><span class="n">dense_mesh</span><span class="p">[</span><span class="s2">&quot;dp_replicate&quot;</span><span class="p">,</span> <span class="s2">&quot;dp_cp_shard&quot;</span><span class="p">,</span> <span class="s2">&quot;cp_replicate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="d9d.module.parallelism.model.qwen3_moe.parallelize_qwen3_moe_model" class="doc doc-heading">
            <code class=" language-python"><span class="n">parallelize_qwen3_moe_model</span><span class="p">(</span><span class="n">dist_context</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Parallelizes the base Qwen3 MoE model components.</p>
<p>This function configures the model layers for distributed execution within a pipeline
stage. It applies Hybrid Sharded Data Parallelism (HSDP) to dense components (embeddings,
norms, attention) and Expert Parallelism (EP) to the Mixture-of-Experts (MLP) layers.</p>
<p>Current usage constraints:
*   Tensor Parallelism is not supported (we may implement it later).
*   Context Parallelism is not supported (we will implement it later).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dist_context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DistributedContext (d9d.core.dist_context.DistributedContext)" href="../../core/dist_context/#d9d.core.dist_context.DistributedContext">DistributedContext</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The distributed context.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Qwen3MoEModel (d9d.module.model.qwen3_moe.Qwen3MoEModel)" href="#d9d.module.model.qwen3_moe.Qwen3MoEModel">Qwen3MoEModel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Qwen3 MoE base model to parallelize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stage</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PipelineStageInfo


  
      dataclass
   (d9d.pipelining.api.PipelineStageInfo)" href="../3_pipeline_parallelism/#d9d.pipelining.api.PipelineStageInfo">PipelineStageInfo</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Information about the current pipeline stage.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table></div>


<p><span class="doc-section-title">Raises:</span></p>
    <div class="table-wrapper"><table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If Tensor Parallel or Context Parallel is enabled in the context.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>d9d/module/parallelism/model/qwen3_moe.py</code></summary>
              <div class="codehilite"><div class="table-wrapper"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parallelize_qwen3_moe_model</span><span class="p">(</span><span class="n">dist_context</span><span class="p">:</span> <span class="n">DistributedContext</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Qwen3MoEModel</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">PipelineStageInfo</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parallelizes the base Qwen3 MoE model components.</span>

<span class="sd">    This function configures the model layers for distributed execution within a pipeline</span>
<span class="sd">    stage. It applies Hybrid Sharded Data Parallelism (HSDP) to dense components (embeddings,</span>
<span class="sd">    norms, attention) and Expert Parallelism (EP) to the Mixture-of-Experts (MLP) layers.</span>

<span class="sd">    Current usage constraints:</span>
<span class="sd">    *   Tensor Parallelism is not supported (we may implement it later).</span>
<span class="sd">    *   Context Parallelism is not supported (we will implement it later).</span>

<span class="sd">    Args:</span>
<span class="sd">        dist_context: The distributed context.</span>
<span class="sd">        model: The Qwen3 MoE base model to parallelize.</span>
<span class="sd">        stage: Information about the current pipeline stage.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If Tensor Parallel or Context Parallel is enabled in the context.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dims</span> <span class="o">=</span> <span class="n">dist_context</span><span class="o">.</span><span class="n">mesh_params</span>
    <span class="n">dense_mesh</span> <span class="o">=</span> <span class="n">dist_context</span><span class="o">.</span><span class="n">mesh_for</span><span class="p">(</span><span class="n">DENSE_DOMAIN</span><span class="p">)</span>
    <span class="n">expert_mesh</span> <span class="o">=</span> <span class="n">dist_context</span><span class="o">.</span><span class="n">mesh_for</span><span class="p">(</span><span class="n">EXPERT_DOMAIN</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dims</span><span class="o">.</span><span class="n">has_tensor_parallel</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tensor Parallel currently is not supported for this model.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dims</span><span class="o">.</span><span class="n">has_context_parallel_replicate</span> <span class="ow">or</span> <span class="n">dims</span><span class="o">.</span><span class="n">has_context_parallel_shard</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Context Parallel currently is not supported for this model.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_current_stage_first</span><span class="p">:</span>
        <span class="n">parallelize_hsdp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">embed_tokens</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">dense_mesh</span><span class="p">[</span><span class="s2">&quot;dp_replicate&quot;</span><span class="p">,</span> <span class="s2">&quot;dp_cp_shard&quot;</span><span class="p">,</span> <span class="s2">&quot;cp_replicate&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">is_current_stage_last</span><span class="p">:</span>
        <span class="n">parallelize_hsdp</span><span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span>
            <span class="n">mesh</span><span class="o">=</span><span class="n">dense_mesh</span><span class="p">[</span><span class="s2">&quot;dp_replicate&quot;</span><span class="p">,</span> <span class="s2">&quot;dp_cp_shard&quot;</span><span class="p">,</span> <span class="s2">&quot;cp_replicate&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">parallelize_expert_parallel</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">mlp</span><span class="p">,</span> <span class="n">mesh_experts</span><span class="o">=</span><span class="n">expert_mesh</span><span class="p">[</span><span class="s2">&quot;ep_replicate&quot;</span><span class="p">,</span> <span class="s2">&quot;ep_shard&quot;</span><span class="p">])</span>

        <span class="n">parallelize_hsdp</span><span class="p">(</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">self_attn</span><span class="p">,</span>
            <span class="n">mesh</span><span class="o">=</span><span class="n">dense_mesh</span><span class="p">[</span><span class="s2">&quot;dp_replicate&quot;</span><span class="p">,</span> <span class="s2">&quot;dp_cp_shard&quot;</span><span class="p">,</span> <span class="s2">&quot;cp_replicate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">parallelize_hsdp</span><span class="p">(</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">input_layernorm</span><span class="p">,</span>
            <span class="n">mesh</span><span class="o">=</span><span class="n">dense_mesh</span><span class="p">[</span><span class="s2">&quot;dp_replicate&quot;</span><span class="p">,</span> <span class="s2">&quot;dp_cp_shard&quot;</span><span class="p">,</span> <span class="s2">&quot;cp_replicate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">parallelize_hsdp</span><span class="p">(</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">post_attention_layernorm</span><span class="p">,</span>
            <span class="n">mesh</span><span class="o">=</span><span class="n">dense_mesh</span><span class="p">[</span><span class="s2">&quot;dp_replicate&quot;</span><span class="p">,</span> <span class="s2">&quot;dp_cp_shard&quot;</span><span class="p">,</span> <span class="s2">&quot;cp_replicate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
  </div>
</article>
                                <div class="mx-auto flex flex-wrap h-16 w-full max-w-2xl items-center gap-2 px-4 md:px-0">
    
    <a data-slot="button"
        class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*='size-'])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive bg-secondary text-secondary-foreground hover:bg-secondary/80 h-8 rounded-md gap-1.5 px-3 has-[&gt;svg]:px-2.5 shadow-none"
        href="/d9d/models/4_model_catalogue/">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="tabler-icon tabler-icon-arrow-left ">
            <path d="M5 12l14 0"></path>
            <path d="M5 12l6 6"></path>
            <path d="M5 12l6 -6"></path>
        </svg>
        <span class="max-[500px]:hidden">Model Catalogue</span>
    </a>
    
    
    <a data-slot="button"
        class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*='size-'])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive bg-secondary text-secondary-foreground hover:bg-secondary/80 h-8 rounded-md gap-1.5 px-3 has-[&gt;svg]:px-2.5 ml-auto shadow-none"
        href="/d9d/modules/attention/">
        <span class="max-[500px]:hidden">Attention Layers</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="tabler-icon tabler-icon-arrow-right ">
            <path d="M5 12l14 0"></path>
            <path d="M13 18l6 -6"></path>
            <path d="M13 6l6 6"></path>
        </svg>
    </a>
    
</div>
                                <dialog id="bottom-sidebar" onclick="onBottomSidebarDialogClick(event)" class="bg-transparent"
    style="position: fixed; left: 0px; top: 0px; transform: translate(0px, 58px); min-width: max-content; --radix-popper-transform-origin: 0% 0px; will-change: transform; z-index: 50; --radix-popper-available-width: 504px; --radix-popper-available-height: 857px; --radix-popper-anchor-width: 72.94999694824219px; --radix-popper-anchor-height: 32px;">
    <div data-side="bottom" data-align="start" data-state="open" role="dialog" data-slot="popover-content"
        class="text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 origin-(--radix-popover-content-transform-origin) border outline-hidden bg-background/90 no-scrollbar h-(--radix-popper-available-height) w-(--radix-popper-available-width) overflow-y-auto rounded-none border-none p-0 shadow-none backdrop-blur duration-100"
        style="--radix-popover-content-transform-origin: var(--radix-popper-transform-origin); --radix-popover-content-available-width: var(--radix-popper-available-width); --radix-popover-content-available-height: var(--radix-popper-available-height); --radix-popover-trigger-width: var(--radix-popper-anchor-width); --radix-popover-trigger-height: var(--radix-popper-anchor-height);"
        tabindex="-1">
        <div class="flex flex-col gap-12 overflow-auto px-6 py-6">
            
            
            

            
            <div class="flex flex-col gap-4">
                <div class="text-muted-foreground text-sm font-medium">Menu</div>
                <div class="flex flex-col gap-3">
                    
                    <a class="text-2xl font-medium" href="../..">
                        
                        Home
                        
                    </a>
                    
                    <a class="text-2xl font-medium" href="../../toc/">
                        
                        Table of Contents
                        
                    </a>
                    
                </div>
            </div>
            

            
            <div class="flex flex-col gap-8">
                
                <div class="flex flex-col gap-4">
                    <div class="text-muted-foreground text-sm font-medium">Loop</div>
                    
                    <div class="flex flex-col gap-3">
                        
                        <a class="text-2xl font-medium" href="../../0_loop/0_index/">
                            
                            Training Loop
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../0_loop/1_inference_loop/">
                            
                            Inference Loop
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../0_loop/config/">
                            
                            Configuration
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../0_loop/interfaces/">
                            
                            Interfaces & Logic
                            
                        </a>
                        
                    </div>
                    
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="text-muted-foreground text-sm font-medium">Core</div>
                    
                    <div class="flex flex-col gap-3">
                        
                        <a class="text-2xl font-medium" href="../../core/autograd_extensions/">
                            
                            Autograd Extensions
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../core/dist_context/">
                            
                            Distributed Context
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../core/dist_ops/">
                            
                            Distributed Operations
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../core/sharding/">
                            
                            PyTree Sharding
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../core/types/">
                            
                            Typing Extensions
                            
                        </a>
                        
                    </div>
                    
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="text-muted-foreground text-sm font-medium">Dataset</div>
                    
                    <div class="flex flex-col gap-3">
                        
                        <a class="text-2xl font-medium" href="../../dataset/">
                            
                            Datasets
                            
                        </a>
                        
                    </div>
                    
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="text-muted-foreground text-sm font-medium">Internals</div>
                    
                    <div class="flex flex-col gap-3">
                        
                        <a class="text-2xl font-medium" href="../../internals/determinism/">
                            
                            Determinism
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../internals/grad_norm/">
                            
                            Gradient Norm & Clipping
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../internals/grad_sync/">
                            
                            Gradient Synchronization
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../internals/metric_collector/">
                            
                            Metric Collection
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../internals/pipeline_state/">
                            
                            Pipeline State Management
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../internals/pipelining/">
                            
                            Pipelining Internals
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../internals/profiling/">
                            
                            Distributed Profiling
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../internals/tracker_integration/">
                            
                            Experiment Tracking
                            
                        </a>
                        
                    </div>
                    
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="text-muted-foreground text-sm font-medium">Lr scheduler</div>
                    
                    <div class="flex flex-col gap-3">
                        
                        <a class="text-2xl font-medium" href="../../lr_scheduler/piecewise/">
                            
                            Piecewise Scheduler
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../lr_scheduler/visualization/">
                            
                            Visualization
                            
                        </a>
                        
                    </div>
                    
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="text-muted-foreground text-sm font-medium">Metric</div>
                    
                    <div class="flex flex-col gap-3">
                        
                        <a class="text-2xl font-medium" href="../../metric/0_index/">
                            
                            Metrics
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../metric/custom/">
                            
                            Custom Metrics
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../metric/implemented/">
                            
                            Implemented Metrics
                            
                        </a>
                        
                    </div>
                    
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="text-muted-foreground text-sm font-medium">Model states</div>
                    
                    <div class="flex flex-col gap-3">
                        
                        <a class="text-2xl font-medium" href="../../model_states/io/">
                            
                            Model State I/O
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../model_states/mapper/">
                            
                            Model State Mapper
                            
                        </a>
                        
                    </div>
                    
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="text-muted-foreground text-sm font-medium">Models</div>
                    
                    <div class="flex flex-col gap-3">
                        
                        <a class="text-2xl font-medium" href="../1_model_design/">
                            
                            Model Design
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../2_horizontal_parallelism/">
                            
                            Horizontal Parallelism
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../3_pipeline_parallelism/">
                            
                            Pipeline Parallelism
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../4_model_catalogue/">
                            
                            Model Catalogue
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="./">
                            
                            Qwen3 MoE
                            
                        </a>
                        
                    </div>
                    
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="text-muted-foreground text-sm font-medium">Modules</div>
                    
                    <div class="flex flex-col gap-3">
                        
                        <a class="text-2xl font-medium" href="../../modules/attention/">
                            
                            Attention Layers
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../modules/embedding/">
                            
                            Embeddings
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../modules/ffn/">
                            
                            Feed Forward Networks (FFN)
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../modules/head/">
                            
                            Model Heads
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../modules/hidden_states_aggregator/">
                            
                            Hidden States Aggregation
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../modules/moe/">
                            
                            Mixture of Experts (MoE)
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../modules/positional/">
                            
                            Positional Embeddings
                            
                        </a>
                        
                    </div>
                    
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="text-muted-foreground text-sm font-medium">Optimizer</div>
                    
                    <div class="flex flex-col gap-3">
                        
                        <a class="text-2xl font-medium" href="../../optimizer/stochastic/">
                            
                            Stochastic Optimizers
                            
                        </a>
                        
                    </div>
                    
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="text-muted-foreground text-sm font-medium">Peft</div>
                    
                    <div class="flex flex-col gap-3">
                        
                        <a class="text-2xl font-medium" href="../../peft/0_index/">
                            
                            PEFT Overview
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../peft/full_tune/">
                            
                            Full Fine-Tuning
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../peft/lora/">
                            
                            LoRA
                            
                        </a>
                        
                        <a class="text-2xl font-medium" href="../../peft/stack/">
                            
                            Method Stacking
                            
                        </a>
                        
                    </div>
                    
                </div>
                
            </div>
            
            

        </div>
    </div>
</dialog>
                            </div>
                            <div
                                class="sticky top-[calc(var(--header-height)+1px)] z-30 ml-auto hidden h-[calc(100svh-var(--header-height)-var(--footer-height))] w-72 flex-col gap-4 overflow-hidden overscroll-none pb-8 xl:flex">
                                <div class="h-(--top-spacing) shrink-0"></div>
                                <div view-transition-name="toc" class="no-scrollbar overflow-y-auto px-8">
    <div class="flex flex-col gap-2 p-4 pt-0 text-sm">
        <p class="text-muted-foreground bg-background sticky top-0 h-6 text-xs">On This Page</p>
        
        
        
        
        <a href="#about"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="2">
            About
        </a>
        

        
        <a href="#d9d.module.model.qwen3_moe"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="2">
            qwen3_moe
        </a>
        
        
        <a href="#d9d.module.model.qwen3_moe.Qwen3MoEForCausalLM"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="3">
            Qwen3MoEForCausalLM
        </a>
        
        <a href="#d9d.module.model.qwen3_moe.Qwen3MoEForCausalLMParameters"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="3">
            Qwen3MoEForCausalLMParameters
        </a>
        
        <a href="#d9d.module.model.qwen3_moe.Qwen3MoEForClassification"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="3">
            Qwen3MoEForClassification
        </a>
        
        <a href="#d9d.module.model.qwen3_moe.Qwen3MoEForClassificationParameters"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="3">
            Qwen3MoEForClassificationParameters
        </a>
        
        <a href="#d9d.module.model.qwen3_moe.Qwen3MoELayer"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="3">
            Qwen3MoELayer
        </a>
        
        <a href="#d9d.module.model.qwen3_moe.Qwen3MoELayerParameters"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="3">
            Qwen3MoELayerParameters
        </a>
        
        <a href="#d9d.module.model.qwen3_moe.Qwen3MoEModel"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="3">
            Qwen3MoEModel
        </a>
        
        <a href="#d9d.module.model.qwen3_moe.Qwen3MoEParameters"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="3">
            Qwen3MoEParameters
        </a>
        
        

        
        <a href="#d9d.module.parallelism.model.qwen3_moe"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="2">
            qwen3_moe
        </a>
        
        
        <a href="#d9d.module.parallelism.model.qwen3_moe.parallelize_qwen3_moe_for_causal_lm"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="3">
            parallelize_qwen3_moe_for_causal_lm
        </a>
        
        <a href="#d9d.module.parallelism.model.qwen3_moe.parallelize_qwen3_moe_for_classification"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="3">
            parallelize_qwen3_moe_for_classification
        </a>
        
        <a href="#d9d.module.parallelism.model.qwen3_moe.parallelize_qwen3_moe_model"
            class="text-muted-foreground hover:text-foreground data-[active=true]:text-foreground text-[0.8rem] no-underline transition-colors data-[depth=3]:pl-4 data-[depth=4]:pl-6"
            data-active="false" data-depth="3">
            parallelize_qwen3_moe_model
        </a>
        
        

        
        
        
        

    </div>
    <div class="h-12"></div>
</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer view-transition-name="footer"
    class="group-has-[.section-soft]/body:bg-surface/40 3xl:fixed:bg-transparent dark:bg-transparent">
    <div class="container-wrapper px-4 xl:px-6">
        <div class="flex h-(--footer-height) items-center justify-between">
            <div class="text-muted-foreground w-full text-center text-xs leading-loose sm:text-sm">
                
                <a href="https://github.com/asiffer/mkdocs-shadcn">shadcn theme</a> provided by
                <a href="https://github.com/asiffer">@asiffer</a>
            </div>
        </div>
    </div>
</footer>
    </div>
     

<script src="../../search/main.js"></script>


    

    <script src="../../js/copy-button.js"></script>
    <script>updatePygmentsStylesheet();</script>
    
    <script>fetchStargazers("https://github.com/d9d-project/d9d");</script>
    
    
    <script>
    for (const el of document.querySelectorAll(
        ".typography .doc code.language-python",
    )) {
        el.classList.add("codehilite");
    }

    for (const el of document.querySelectorAll("article .doc .doc-contents")) {
        el.innerHTML = el.innerHTML.trim();
    }
</script>
    
    
    <script type="speculationrules">
{
  "prerender": [
    {
      "where": {
          "selector_matches": ["#next-button", "#previous-button"],
      }
    }
  ]
}
</script>
</body>

</html>